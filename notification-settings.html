<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container my-5" style="margin-top: 5rem !important;">
        <h1 class="mb-4"><i class="fas fa-bell"></i> Notification Settings</h1>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Email Notifications</h5>
                <p class="text-muted">Choose which notifications you want to receive via email</p>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="comment_reply_email">
                    <label class="form-check-label" for="comment_reply_email">
                        <strong>Comment Replies</strong><br>
                        <small class="text-muted">Get notified when someone replies to your comment</small>
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="article_published_email">
                    <label class="form-check-label" for="article_published_email">
                        <strong>New Articles</strong><br>
                        <small class="text-muted">Get notified when new articles are published</small>
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="prayer_update_email">
                    <label class="form-check-label" for="prayer_update_email">
                        <strong>Prayer Updates</strong><br>
                        <small class="text-muted">Get notified about prayer request updates</small>
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="event_reminder_email">
                    <label class="form-check-label" for="event_reminder_email">
                        <strong>Event Reminders</strong><br>
                        <small class="text-muted">Get notified about upcoming events</small>
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3" id="adminAlertSection" style="display: none;">
                    <input class="form-check-input" type="checkbox" id="admin_alert_email">
                    <label class="form-check-label" for="admin_alert_email">
                        <strong>Admin Alerts</strong><br>
                        <small class="text-muted">Get notified about new submissions and reports</small>
                    </label>
                </div>
                
                <button class="btn btn-primary mt-3" onclick="savePreferences()">Save Preferences</button>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Recent Notifications</h5>
                <div id="notificationsList"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="navbar.js"></script>
    <script>
        const API_URL = 'https://diz6ceeb22.execute-api.us-east-1.amazonaws.com/prod/notifications';
        let userEmail = '';

        $(document).ready(function() {
            const userData = localStorage.getItem('user_data');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userData);
            userEmail = user.email;
            
            if (user.role === 'admin' || user.role === 'super_user') {
                $('#adminAlertSection').show();
            }

            fetch('navbar.html')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('navbar-container').innerHTML = html;
                    initNavbar();
                });

            loadPreferences();
            loadNotifications();
        });

        function loadPreferences() {
            fetch(API_URL + '?action=get_preferences&email=' + encodeURIComponent(userEmail))
                .then(r => r.json())
                .then(data => {
                    const prefs = data.preferences || {};
                    $('#comment_reply_email').prop('checked', prefs.comment_reply_email !== false);
                    $('#article_published_email').prop('checked', prefs.article_published_email !== false);
                    $('#prayer_update_email').prop('checked', prefs.prayer_update_email !== false);
                    $('#event_reminder_email').prop('checked', prefs.event_reminder_email !== false);
                    $('#admin_alert_email').prop('checked', prefs.admin_alert_email !== false);
                });
        }

        function savePreferences() {
            const prefs = {
                comment_reply_email: $('#comment_reply_email').is(':checked'),
                article_published_email: $('#article_published_email').is(':checked'),
                prayer_update_email: $('#prayer_update_email').is(':checked'),
                event_reminder_email: $('#event_reminder_email').is(':checked'),
                admin_alert_email: $('#admin_alert_email').is(':checked')
            };

            fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'update_preferences', email: userEmail, preferences: prefs})
            })
            .then(r => r.json())
            .then(() => {
                alert('Preferences saved!');
            });
        }

        function loadNotifications() {
            fetch(API_URL + '?action=get_user_notifications&email=' + encodeURIComponent(userEmail))
                .then(r => r.json())
                .then(data => {
                    const notifications = data.notifications || [];
                    const container = $('#notificationsList');
                    container.empty();
                    
                    if (notifications.length === 0) {
                        container.append('<p class="text-muted">No notifications yet</p>');
                        return;
                    }
                    
                    notifications.forEach(n => {
                        const date = new Date(n.created_at).toLocaleString();
                        const readClass = n.read ? 'text-muted' : 'fw-bold';
                        container.append(`
                            <div class="border-bottom py-3">
                                <div class="${readClass}">${n.subject}</div>
                                <small class="text-muted">${date}</small>
                                <p class="mb-1">${n.message}</p>
                                ${n.link ? `<a href="${n.link}" class="btn btn-sm btn-outline-primary">View</a>` : ''}
                                ${!n.read ? `<button class="btn btn-sm btn-outline-secondary ms-2" onclick="markRead('${n.notification_id}')">Mark Read</button>` : ''}
                            </div>
                        `);
                    });
                });
        }

        function markRead(id) {
            fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'mark_read', notification_id: id})
            })
            .then(() => loadNotifications());
        }
    </script>
</body>
</html>

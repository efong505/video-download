<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayer Moderation - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="admin.html">Admin Panel</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="admin.html">Dashboard</a>
                <a class="nav-link active" href="admin-prayers.html">Prayers</a>
                <a class="nav-link" href="prayer-wall.html" target="_blank">View Public Wall</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Prayer Request Moderation</h2>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="moderationToggle" onchange="toggleModeration()">
                <label class="form-check-label" for="moderationToggle">Require Approval</label>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" data-tab="pending" href="#">Pending <span id="pendingCount" class="badge bg-warning">0</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="active" href="#">Active <span id="activeCount" class="badge bg-success">0</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="answered" href="#">Answered <span id="answeredCount" class="badge bg-info">0</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="archived" href="#">Archived <span id="archivedCount" class="badge bg-secondary">0</span></a>
            </li>
        </ul>

        <div id="prayerList"></div>
    </div>

    <!-- Mark Answered Modal -->
    <div class="modal fade" id="answeredModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mark as Answered</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="testimonyText" rows="4" placeholder="Share how God answered this prayer..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveAnswered()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://cayl9dmtaf.execute-api.us-east-1.amazonaws.com/prod';
        let currentTab = 'pending';
        let currentRequestId = null;

        $(document).ready(function() {
            checkAuth();
            loadConfig();
            loadPrayers();

            $('.nav-link[data-tab]').click(function(e) {
                e.preventDefault();
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                currentTab = $(this).data('tab');
                loadPrayers();
            });
        });

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const userData = localStorage.getItem('user_data');
            if (!token || !userData) {
                alert('Please log in as admin');
                window.location.href = 'login.html';
                return false;
            }
            const user = JSON.parse(userData);
            if (user.role !== 'admin' && user.role !== 'super_user') {
                alert('Admin access required');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        function loadPrayers() {
            const status = currentTab === 'pending' ? 'pending' : currentTab;
            
            $.get(`${API_URL}?action=list&status=${status}`, function(data) {
                displayPrayers(data.prayers || []);
            });
            
            // Load all prayers for accurate counts
            $.get(`${API_URL}?action=list`, function(data) {
                updateCounts(data.prayers || []);
            });
        }

        function updateCounts(prayers) {
            const counts = { pending: 0, active: 0, answered: 0, archived: 0 };
            prayers.forEach(p => counts[p.status]++);
            
            $('#pendingCount').text(counts.pending);
            $('#activeCount').text(counts.active);
            $('#answeredCount').text(counts.answered);
            $('#archivedCount').text(counts.archived);
        }

        function displayPrayers(prayers) {
            if (prayers.length === 0) {
                $('#prayerList').html('<div class="alert alert-info">No prayer requests</div>');
                return;
            }

            let html = '<div class="row">';
            prayers.forEach(prayer => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <h5>${escapeHtml(prayer.title)}</h5>
                                    <span class="badge bg-primary">${prayer.category}</span>
                                </div>
                                <p>${escapeHtml(prayer.description)}</p>
                                ${prayer.testimony ? `<div class="alert alert-success"><strong>Testimony:</strong> ${escapeHtml(prayer.testimony)}</div>` : ''}
                                <div class="text-muted small mb-3">
                                    <strong>From:</strong> ${prayer.privacy === 'private' ? 'Anonymous' : escapeHtml(prayer.submitted_by_name)} (${prayer.submitted_by})<br>
                                    ${prayer.state ? `<strong>State:</strong> ${prayer.state}<br>` : ''}
                                    <strong>Submitted:</strong> ${new Date(prayer.created_at).toLocaleString()}<br>
                                    <strong>Prayer Count:</strong> ${prayer.prayer_count || 0}
                                </div>
                                <div class="btn-group w-100">
                                    ${currentTab === 'pending' ? `
                                        <button class="btn btn-success btn-sm" onclick="updateStatus('${prayer.request_id}', 'active')">Approve</button>
                                        <button class="btn btn-danger btn-sm" onclick="deletePrayer('${prayer.request_id}')">Reject</button>
                                    ` : ''}
                                    ${currentTab === 'active' ? `
                                        <button class="btn btn-success btn-sm" onclick="markAnswered('${prayer.request_id}')">Mark Answered</button>
                                        <button class="btn btn-secondary btn-sm" onclick="updateStatus('${prayer.request_id}', 'archived')">Archive</button>
                                    ` : ''}
                                    ${currentTab === 'answered' || currentTab === 'archived' ? `
                                        <button class="btn btn-primary btn-sm" onclick="updateStatus('${prayer.request_id}', 'active')">Restore</button>
                                        <button class="btn btn-danger btn-sm" onclick="deletePrayer('${prayer.request_id}')">Delete</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            $('#prayerList').html(html);
        }

        function updateStatus(requestId, status) {
            $.ajax({
                url: API_URL,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'update',
                    request_id: requestId,
                    status: status
                }),
                success: function() {
                    loadPrayers();
                }
            });
        }

        function markAnswered(requestId) {
            currentRequestId = requestId;
            $('#testimonyText').val('');
            new bootstrap.Modal($('#answeredModal')).show();
        }

        function saveAnswered() {
            const testimony = $('#testimonyText').val();
            
            $.ajax({
                url: API_URL,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'update',
                    request_id: currentRequestId,
                    status: 'answered',
                    testimony: testimony,
                    answered_at: new Date().toISOString()
                }),
                success: function() {
                    bootstrap.Modal.getInstance($('#answeredModal')).hide();
                    loadPrayers();
                }
            });
        }

        function deletePrayer(requestId) {
            if (!confirm('Delete this prayer request?')) return;

            $.ajax({
                url: API_URL,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'delete',
                    request_id: requestId
                }),
                success: function() {
                    loadPrayers();
                }
            });
        }

        function loadConfig() {
            $.get(`${API_URL}?action=get_config`, function(data) {
                $('#moderationToggle').prop('checked', data.require_moderation);
            });
        }

        function toggleModeration() {
            const requireModeration = $('#moderationToggle').is(':checked');
            
            $.ajax({
                url: API_URL,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'set_config',
                    require_moderation: requireModeration
                }),
                success: function() {
                    const msg = requireModeration ? 'Moderation enabled - new prayers require approval' : 'Moderation disabled - new prayers auto-approved';
                    alert(msg);
                },
                error: function() {
                    alert('Failed to update configuration');
                    $('#moderationToggle').prop('checked', !requireModeration);
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

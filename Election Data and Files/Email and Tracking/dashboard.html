<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Subscriber Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stat-card { border-left: 4px solid #667eea; }
        .subscriber-row:hover { background: #f8f9fa; cursor: pointer; }
        .badge-active { background: #28a745; }
        .badge-unsubscribed { background: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">ðŸ“§ Email Subscriber Dashboard</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview">ðŸ“Š Overview</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#subscribers">ðŸ‘¥ Subscribers</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#campaigns">ðŸ“§ Campaigns</button>
            </li>
        </ul>

        <div class="tab-content mt-4">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted">Total Subscribers</h6>
                                <h2 id="stat-total">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted">Active</h6>
                                <h2 id="stat-active" class="text-success">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted">Total Opens</h6>
                                <h2 id="stat-opens">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h6 class="text-muted">Total Clicks</h6>
                                <h2 id="stat-clicks">-</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><strong>Recent Subscribers</strong></div>
                            <div class="card-body">
                                <div id="recent-subscribers">Loading...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><strong>Top Engaged</strong></div>
                            <div class="card-body">
                                <div id="top-engaged">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscribers Tab -->
            <div class="tab-pane fade" id="subscribers">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>All Subscribers</strong>
                        <div>
                            <input type="text" id="search-input" class="form-control form-control-sm d-inline-block" style="width: 250px;" placeholder="Search email...">
                            <button class="btn btn-sm btn-success" onclick="exportCSV()">ðŸ“¥ Export CSV</button>
                            <button class="btn btn-sm btn-primary" onclick="loadSubscribers()">ðŸ”„ Refresh</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Subscribed</th>
                                    <th>Opens</th>
                                    <th>Clicks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="subscribers-table">
                                <tr><td colspan="6" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div class="tab-pane fade" id="campaigns">
                <div class="card">
                    <div class="card-header"><strong>Campaign Performance</strong></div>
                    <div class="card-body">
                        <div id="campaigns-list">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriber Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Subscriber Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detail-content">Loading...</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // AWS Configuration - Update these with your values
        const AWS_REGION = 'us-east-1';
        const SUBSCRIBERS_TABLE = 'email-subscribers';
        const EVENTS_TABLE = 'email-events';
        const API_ENDPOINT = 'https://niexv1rw75.execute-api.us-east-1.amazonaws.com';

        // Initialize AWS SDK (requires AWS credentials configured)
        AWS.config.region = AWS_REGION;
        const dynamodb = new AWS.DynamoDB.DocumentClient();

        let allSubscribers = [];
        let allEvents = [];

        // Load all data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            
            // Search functionality
            document.getElementById('search-input').addEventListener('input', (e) => {
                filterSubscribers(e.target.value);
            });
        });

        async function loadAllData() {
            await Promise.all([loadSubscribers(), loadEvents()]);
            updateStats();
            updateRecentSubscribers();
            updateTopEngaged();
            updateCampaigns();
        }

        async function loadSubscribers() {
            try {
                const params = { TableName: SUBSCRIBERS_TABLE };
                const result = await dynamodb.scan(params).promise();
                allSubscribers = result.Items;
                renderSubscribersTable(allSubscribers);
            } catch (error) {
                console.error('Error loading subscribers:', error);
                document.getElementById('subscribers-table').innerHTML = 
                    '<tr><td colspan="6" class="text-danger">Error loading data. Check AWS credentials.</td></tr>';
            }
        }

        async function loadEvents() {
            try {
                const params = { TableName: EVENTS_TABLE };
                const result = await dynamodb.scan(params).promise();
                allEvents = result.Items;
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        function updateStats() {
            const total = allSubscribers.length;
            const active = allSubscribers.filter(s => s.status === 'active').length;
            const totalOpens = allSubscribers.reduce((sum, s) => sum + (s.total_opens || 0), 0);
            const totalClicks = allSubscribers.reduce((sum, s) => sum + (s.total_clicks || 0), 0);

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-opens').textContent = totalOpens;
            document.getElementById('stat-clicks').textContent = totalClicks;
        }

        function updateRecentSubscribers() {
            const recent = [...allSubscribers]
                .sort((a, b) => new Date(b.subscribed_at) - new Date(a.subscribed_at))
                .slice(0, 5);

            const html = recent.map(s => `
                <div class="mb-2">
                    <strong>${s.email}</strong>
                    <br><small class="text-muted">${new Date(s.subscribed_at).toLocaleDateString()}</small>
                </div>
            `).join('');

            document.getElementById('recent-subscribers').innerHTML = html || 'No subscribers yet';
        }

        function updateTopEngaged() {
            const top = [...allSubscribers]
                .sort((a, b) => (b.total_opens + b.total_clicks) - (a.total_opens + a.total_clicks))
                .slice(0, 5);

            const html = top.map(s => `
                <div class="mb-2">
                    <strong>${s.email}</strong>
                    <br><small class="text-muted">Opens: ${s.total_opens || 0} | Clicks: ${s.total_clicks || 0}</small>
                </div>
            `).join('');

            document.getElementById('top-engaged').innerHTML = html || 'No activity yet';
        }

        function updateCampaigns() {
            const campaigns = {};
            allEvents.forEach(e => {
                if (!campaigns[e.campaign_id]) {
                    campaigns[e.campaign_id] = { opens: 0, clicks: 0, subscribes: 0 };
                }
                if (e.event_type === 'opened') campaigns[e.campaign_id].opens++;
                if (e.event_type === 'clicked') campaigns[e.campaign_id].clicks++;
                if (e.event_type === 'subscribed') campaigns[e.campaign_id].subscribes++;
            });

            const html = Object.entries(campaigns).map(([id, stats]) => `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>${id}</h5>
                        <div class="row">
                            <div class="col">Opens: <strong>${stats.opens}</strong></div>
                            <div class="col">Clicks: <strong>${stats.clicks}</strong></div>
                            <div class="col">Subscribes: <strong>${stats.subscribes}</strong></div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('campaigns-list').innerHTML = html || 'No campaigns yet';
        }

        function renderSubscribersTable(subscribers) {
            const html = subscribers.map(s => `
                <tr class="subscriber-row" onclick="showDetails('${s.email}')">
                    <td>${s.email}</td>
                    <td><span class="badge ${s.status === 'active' ? 'badge-active' : 'badge-unsubscribed'}">${s.status}</span></td>
                    <td>${new Date(s.subscribed_at).toLocaleDateString()}</td>
                    <td>${s.total_opens || 0}</td>
                    <td>${s.total_clicks || 0}</td>
                    <td>
                        ${s.status === 'active' 
                            ? `<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); unsubscribe('${s.email}')">Unsubscribe</button>`
                            : `<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); resubscribe('${s.email}')">Resubscribe</button>`
                        }
                    </td>
                </tr>
            `).join('');

            document.getElementById('subscribers-table').innerHTML = html || '<tr><td colspan="6" class="text-center">No subscribers</td></tr>';
        }

        function filterSubscribers(query) {
            const filtered = allSubscribers.filter(s => 
                s.email.toLowerCase().includes(query.toLowerCase())
            );
            renderSubscribersTable(filtered);
        }

        function showDetails(email) {
            const subscriber = allSubscribers.find(s => s.email === email);
            const events = allEvents.filter(e => e.email === email);

            const html = `
                <p><strong>Email:</strong> ${subscriber.email}</p>
                <p><strong>Status:</strong> ${subscriber.status}</p>
                <p><strong>Subscribed:</strong> ${new Date(subscriber.subscribed_at).toLocaleString()}</p>
                <p><strong>Source:</strong> ${subscriber.source || 'Unknown'}</p>
                <p><strong>Total Opens:</strong> ${subscriber.total_opens || 0}</p>
                <p><strong>Total Clicks:</strong> ${subscriber.total_clicks || 0}</p>
                <p><strong>Last Activity:</strong> ${subscriber.last_activity ? new Date(subscriber.last_activity).toLocaleString() : 'None'}</p>
                <hr>
                <h6>Recent Activity</h6>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${events.slice(0, 10).map(e => `
                        <small>${e.event_type} - ${e.campaign_id} - ${new Date(e.date).toLocaleString()}</small><br>
                    `).join('') || 'No activity'}
                </div>
            `;

            document.getElementById('detail-content').innerHTML = html;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        async function unsubscribe(email) {
            if (!confirm(`Unsubscribe ${email}?`)) return;

            try {
                const response = await fetch(`${API_ENDPOINT}/unsubscribe?email=${encodeURIComponent(email)}`);
                if (response.ok) {
                    alert('Unsubscribed successfully');
                    loadAllData();
                } else {
                    alert('Failed to unsubscribe');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error unsubscribing');
            }
        }

        async function resubscribe(email) {
            if (!confirm(`Resubscribe ${email}?`)) return;

            try {
                const params = {
                    TableName: SUBSCRIBERS_TABLE,
                    Key: { email },
                    UpdateExpression: 'SET #status = :status REMOVE unsubscribed_at',
                    ExpressionAttributeNames: { '#status': 'status' },
                    ExpressionAttributeValues: { ':status': 'active' }
                };
                await dynamodb.update(params).promise();
                alert('Resubscribed successfully');
                loadAllData();
            } catch (error) {
                console.error('Error:', error);
                alert('Error resubscribing');
            }
        }

        function exportCSV() {
            const csv = [
                ['Email', 'Status', 'Subscribed', 'Source', 'Opens', 'Clicks', 'Last Activity'],
                ...allSubscribers.map(s => [
                    s.email,
                    s.status,
                    s.subscribed_at,
                    s.source || '',
                    s.total_opens || 0,
                    s.total_clicks || 0,
                    s.last_activity || ''
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subscribers_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1000.0.min.js"></script>
</body>
</html>

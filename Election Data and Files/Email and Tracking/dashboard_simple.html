<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Subscriber Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .stat-card { border-left: 4px solid #667eea; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .subscriber-row:hover { background: #f8f9fa; cursor: pointer; }
        #quill-editor { height: 300px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üìß Email Subscriber Dashboard</span>
            <span class="text-white" id="last-updated"></span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <ul class="nav nav-tabs" id="mainTab">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview">üìä Overview</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#subscribers">üë• Subscribers</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#campaigns">üìß Campaigns</button>
            </li>
        </ul>

        <div class="tab-content mt-4">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Total Subscribers</h6>
                                <h2 id="stat-total" class="mb-0">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Active</h6>
                                <h2 id="stat-active" class="text-success mb-0">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Total Opens</h6>
                                <h2 id="stat-opens" class="mb-0">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Total Clicks</h6>
                                <h2 id="stat-clicks" class="mb-0">-</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4 g-3">
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light"><strong>üìÖ Recent Subscribers</strong></div>
                            <div class="card-body" id="recent-subscribers" style="max-height: 300px; overflow-y: auto;">Loading...</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light"><strong>üî• Top Engaged</strong></div>
                            <div class="card-body" id="top-engaged" style="max-height: 300px; overflow-y: auto;">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscribers Tab -->
            <div class="tab-pane fade" id="subscribers">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-success text-white"><strong>‚ûï Add New Subscriber</strong></div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <input type="text" id="new-first-name" class="form-control" placeholder="First Name *">
                            </div>
                            <div class="col-md-3">
                                <input type="text" id="new-last-name" class="form-control" placeholder="Last Name">
                            </div>
                            <div class="col-md-4">
                                <input type="email" id="new-email" class="form-control" placeholder="Email *">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success w-100" onclick="addSubscriber()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <strong>All Subscribers</strong>
                        <div>
                            <input type="text" id="search-input" class="form-control form-control-sm d-inline-block me-2" style="width: 250px;" placeholder="üîç Search...">
                            <button class="btn btn-sm btn-success" onclick="exportCSV()">üì• Export CSV</button>
                            <button class="btn btn-sm btn-primary" onclick="loadAllData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Subscribed</th>
                                        <th>Opens</th>
                                        <th>Clicks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subscribers-table">
                                    <tr><td colspan="7" class="text-center py-4">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaigns Tab -->
            <div class="tab-pane fade" id="campaigns">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-primary text-white"><strong>üìß Send New Campaign</strong></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Campaign ID</label>
                                    <input type="text" id="campaign-id" class="form-control" placeholder="e.g., jan-2025-update">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subject Line</label>
                                    <input type="text" id="campaign-subject" class="form-control" placeholder="e.g., Election Update">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Template</label>
                                    <select id="template-select" class="form-select" onchange="loadTemplate()">
                                        <option value="">Custom (Start from scratch)</option>
                                        <option value="election_update">Election Update (Purple)</option>
                                        <option value="urgent_alert">Urgent Alert (Red)</option>
                                        <option value="newsletter">Newsletter (Professional)</option>
                                        <option value="prayer_action">Prayer & Action (Spiritual)</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-info mt-2 w-100" onclick="previewTemplate()" id="preview-template-btn" style="display: none;">üëÅÔ∏è Preview Template Design</button>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Content Mode</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="content-mode" id="mode-visual" checked>
                                        <label class="btn btn-outline-primary" for="mode-visual" onclick="switchMode('visual')">üìù Visual</label>
                                        <input type="radio" class="btn-check" name="content-mode" id="mode-html">
                                        <label class="btn btn-outline-primary" for="mode-html" onclick="switchMode('html')">üíª HTML</label>
                                        <input type="radio" class="btn-check" name="content-mode" id="mode-markdown">
                                        <label class="btn btn-outline-primary" for="mode-markdown" onclick="switchMode('markdown')">üìÑ Markdown</label>
                                    </div>
                                    <small class="text-muted d-block mt-1">üí° Visual mode preserves full HTML styling. Use HTML mode to edit template code.</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email Content</label>
                                    <div id="editor-container-visual" style="display: block;">
                                        <div id="editor-toolbar" style="border: 1px solid #dee2e6; border-bottom: none; border-radius: 8px 8px 0 0; padding: 8px; background: #f8f9fa;">
                                            <button type="button" onclick="formatDoc('bold')" class="btn btn-sm btn-light" title="Bold"><b>B</b></button>
                                            <button type="button" onclick="formatDoc('italic')" class="btn btn-sm btn-light" title="Italic"><i>I</i></button>
                                            <button type="button" onclick="formatDoc('underline')" class="btn btn-sm btn-light" title="Underline"><u>U</u></button>
                                            <button type="button" onclick="formatDoc('insertUnorderedList')" class="btn btn-sm btn-light" title="Bullet List">‚Ä¢ List</button>
                                            <button type="button" onclick="formatDoc('insertOrderedList')" class="btn btn-sm btn-light" title="Numbered List">1. List</button>
                                            <button type="button" onclick="formatDoc('justifyLeft')" class="btn btn-sm btn-light" title="Align Left">‚¨Ö</button>
                                            <button type="button" onclick="formatDoc('justifyCenter')" class="btn btn-sm btn-light" title="Align Center">‚Üî</button>
                                            <button type="button" onclick="formatDoc('justifyRight')" class="btn btn-sm btn-light" title="Align Right">‚û°</button>
                                            <button type="button" onclick="insertLink()" class="btn btn-sm btn-light" title="Insert Link">üîó</button>
                                            <button type="button" onclick="formatDoc('removeFormat')" class="btn btn-sm btn-light" title="Clear Formatting">‚úñ</button>
                                        </div>
                                        <div id="rich-html-editor" contenteditable="true" style="border: 1px solid #dee2e6; border-radius: 0 0 8px 8px; padding: 15px; min-height: 400px; max-height: 600px; overflow-y: auto; background: white;"></div>
                                    </div>
                                    <div id="editor-container-code" style="display: none;">
                                        <textarea id="campaign-content" class="form-control" rows="12" placeholder="Enter your content here..."></textarea>
                                    </div>
                                    <small class="text-muted">Available placeholders: {{TITLE}}, {{CONTENT}}, {{CTA_TEXT}}, {{CTA_LINK}}, {{PRAYER}}, {{ACTION_STEPS}}, {{DATE}}</small>
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="previewEmail()">üëÅÔ∏è Preview</button>
                                </div>
                                <button class="btn btn-primary w-100" onclick="sendCampaign()">üì§ Send to All Active Subscribers</button>
                                <small class="text-muted d-block mt-2">Will send to <strong id="active-count">-</strong> active subscribers</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light"><strong>Campaign Performance</strong></div>
                            <div class="card-body" id="campaigns-list">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriber Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Subscriber Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detail-content">Loading...</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="email_templates.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let allSubscribers = [];
        let allStats = {};



        async function loadAllData() {
            try {
                const [subs, stats] = await Promise.all([
                    fetch(`${API_BASE}/subscribers`).then(r => r.json()),
                    fetch(`${API_BASE}/stats`).then(r => r.json())
                ]);
                
                allSubscribers = subs;
                allStats = stats;
                
                updateStats();
                renderSubscribersTable(allSubscribers);
                updateRecentSubscribers();
                updateTopEngaged();
                updateCampaigns();
                
                document.getElementById('last-updated').textContent = 
                    'Updated: ' + new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error: Make sure the API server is running (python dashboard_api.py)');
            }
        }

        function updateStats() {
            const active = allStats.active || 0;
            document.getElementById('stat-total').textContent = allStats.total || 0;
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-opens').textContent = allStats.total_opens || 0;
            document.getElementById('stat-clicks').textContent = allStats.total_clicks || 0;
            
            // Update active count in campaign form
            const activeCountEl = document.getElementById('active-count');
            if (activeCountEl) activeCountEl.textContent = active;
        }

        function updateRecentSubscribers() {
            const recent = [...allSubscribers]
                .sort((a, b) => new Date(b.subscribed_at) - new Date(a.subscribed_at))
                .slice(0, 10);

            const html = recent.map(s => `
                <div class="border-bottom pb-2 mb-2">
                    <strong>${s.email}</strong>
                    <span class="badge bg-${s.status === 'active' ? 'success' : 'secondary'} float-end">${s.status}</span>
                    <br><small class="text-muted">${new Date(s.subscribed_at).toLocaleString()}</small>
                </div>
            `).join('');

            document.getElementById('recent-subscribers').innerHTML = html || '<p class="text-muted">No subscribers yet</p>';
        }

        function updateTopEngaged() {
            const top = [...allSubscribers]
                .filter(s => s.status === 'active')
                .sort((a, b) => ((b.total_opens || 0) + (b.total_clicks || 0)) - ((a.total_opens || 0) + (a.total_clicks || 0)))
                .slice(0, 10);

            const html = top.map(s => `
                <div class="border-bottom pb-2 mb-2">
                    <strong>${s.email}</strong>
                    <br><small class="text-muted">
                        üìß ${s.total_opens || 0} opens | üîó ${s.total_clicks || 0} clicks
                    </small>
                </div>
            `).join('');

            document.getElementById('top-engaged').innerHTML = html || '<p class="text-muted">No activity yet</p>';
        }

        function updateCampaigns() {
            const campaigns = allStats.campaigns || {};
            
            const html = Object.entries(campaigns)
                .sort((a, b) => (b[1].opens + b[1].clicks) - (a[1].opens + a[1].clicks))
                .map(([id, stats]) => {
                    const total = stats.opens + stats.clicks + stats.subscribes;
                    return `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">${id}</h5>
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <h3 class="text-primary">${stats.opens}</h3>
                                        <small class="text-muted">Opens</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h3 class="text-success">${stats.clicks}</h3>
                                        <small class="text-muted">Clicks</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h3 class="text-info">${stats.subscribes}</h3>
                                        <small class="text-muted">Subscribes</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h3>${total}</h3>
                                        <small class="text-muted">Total Events</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('campaigns-list').innerHTML = html || '<p class="text-muted">No campaigns yet</p>';
        }

        function renderSubscribersTable(subscribers) {
            const html = subscribers.map(s => {
                const name = [s.first_name, s.last_name].filter(Boolean).join(' ') || '-';
                return `
                <tr class="subscriber-row" onclick="showDetails('${s.email}')">
                    <td>${name}</td>
                    <td>${s.email}</td>
                    <td><span class="badge bg-${s.status === 'active' ? 'success' : 'secondary'}">${s.status}</span></td>
                    <td>${new Date(s.subscribed_at).toLocaleDateString()}</td>
                    <td>${s.total_opens || 0}</td>
                    <td>${s.total_clicks || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); editSubscriber('${s.email}', '${(s.first_name || '').replace(/'/g, "\\'")}',' ${(s.last_name || '').replace(/'/g, "\\'")}')" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); resendEmail('${s.email}')" title="Resend">üìß</button>
                        ${s.status === 'active' 
                            ? `<button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); unsubscribe('${s.email}')" title="Unsubscribe">üö´</button>`
                            : `<button class="btn btn-sm btn-success" onclick="event.stopPropagation(); resubscribe('${s.email}')" title="Resubscribe">‚úÖ</button>`
                        }
                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteSubscriber('${s.email}')" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `}).join('');

            document.getElementById('subscribers-table').innerHTML = html || 
                '<tr><td colspan="7" class="text-center py-4">No subscribers</td></tr>';
        }

        function filterSubscribers(query) {
            const q = query.toLowerCase();
            const filtered = allSubscribers.filter(s => 
                s.email.toLowerCase().includes(q) ||
                (s.first_name || '').toLowerCase().includes(q) ||
                (s.last_name || '').toLowerCase().includes(q)
            );
            renderSubscribersTable(filtered);
        }
        
        async function addSubscriber() {
            const firstName = document.getElementById('new-first-name').value.trim();
            const lastName = document.getElementById('new-last-name').value.trim();
            const email = document.getElementById('new-email').value.trim();
            
            if (!firstName || !email) {
                alert('First name and email are required');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/subscribers`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, first_name: firstName, last_name: lastName})
                });
                
                if (response.ok) {
                    alert('‚úì Subscriber added!');
                    document.getElementById('new-first-name').value = '';
                    document.getElementById('new-last-name').value = '';
                    document.getElementById('new-email').value = '';
                    loadAllData();
                } else {
                    const data = await response.json();
                    alert('‚úó ' + (data.error || 'Failed'));
                }
            } catch (error) {
                alert('‚úó Error adding subscriber');
            }
        }
        
        async function editSubscriber(email, firstName, lastName) {
            const newFirstName = prompt('Edit First Name:', firstName);
            if (newFirstName === null) return;
            
            const newLastName = prompt('Edit Last Name (leave empty to clear):', lastName);
            if (newLastName === null) return;
            
            try {
                const response = await fetch(`${API_BASE}/subscribers/${email}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({first_name: newFirstName.trim(), last_name: newLastName.trim()})
                });
                
                if (response.ok) {
                    alert('‚úì Updated!');
                    loadAllData();
                } else {
                    alert('‚úó Failed');
                }
            } catch (error) {
                alert('‚úó Error');
            }
        }
        
        async function deleteSubscriber(email) {
            if (!confirm(`Delete ${email}?\n\nThis cannot be undone!`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/subscribers/${email}`, {method: 'DELETE'});
                
                if (response.ok) {
                    alert('‚úì Deleted!');
                    loadAllData();
                } else {
                    alert('‚úó Failed');
                }
            } catch (error) {
                alert('‚úó Error');
            }
        }

        async function showDetails(email) {
            const subscriber = allSubscribers.find(s => s.email === email);
            
            document.getElementById('detail-content').innerHTML = 'Loading events...';
            new bootstrap.Modal(document.getElementById('detailModal')).show();
            
            try {
                const events = await fetch(`${API_BASE}/events/${email}`).then(r => r.json());
                
                const html = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Email:</strong> ${subscriber.email}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${subscriber.status === 'active' ? 'success' : 'secondary'}">${subscriber.status}</span></p>
                            <p><strong>Subscribed:</strong> ${new Date(subscriber.subscribed_at).toLocaleString()}</p>
                            <p><strong>Source:</strong> ${subscriber.source || 'Unknown'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Opens:</strong> ${subscriber.total_opens || 0}</p>
                            <p><strong>Total Clicks:</strong> ${subscriber.total_clicks || 0}</p>
                            <p><strong>Last Activity:</strong> ${subscriber.last_activity ? new Date(subscriber.last_activity).toLocaleString() : 'None'}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Recent Activity (${events.length} events)</h6>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${events.sort((a, b) => b.timestamp - a.timestamp).slice(0, 20).map(e => `
                            <div class="border-bottom pb-2 mb-2">
                                <span class="badge bg-primary">${e.event_type}</span>
                                <strong>${e.campaign_id}</strong>
                                <br><small class="text-muted">${new Date(e.date).toLocaleString()}</small>
                            </div>
                        `).join('') || '<p class="text-muted">No activity</p>'}
                    </div>
                `;
                
                document.getElementById('detail-content').innerHTML = html;
            } catch (error) {
                document.getElementById('detail-content').innerHTML = '<p class="text-danger">Error loading events</p>';
            }
        }

        async function unsubscribe(email) {
            if (!confirm(`Unsubscribe ${email}?`)) return;

            try {
                await fetch(`${API_BASE}/subscribers/${email}/unsubscribe`, { method: 'POST' });
                alert('‚úì Unsubscribed successfully');
                loadAllData();
            } catch (error) {
                alert('‚úó Error unsubscribing');
            }
        }

        async function resubscribe(email) {
            if (!confirm(`Resubscribe ${email}?`)) return;

            try {
                await fetch(`${API_BASE}/subscribers/${email}/resubscribe`, { method: 'POST' });
                alert('‚úì Resubscribed successfully');
                loadAllData();
            } catch (error) {
                alert('‚úó Error resubscribing');
            }
        }

        async function resendEmail(email) {
            if (!confirm(`Resend welcome email to ${email}?`)) return;

            try {
                const response = await fetch(`${API_BASE}/subscribers/${email}/resend`, { method: 'POST' });
                if (response.ok) {
                    alert('‚úì Welcome email sent successfully!');
                } else {
                    alert('‚úó Failed to send email');
                }
            } catch (error) {
                alert('‚úó Error sending email');
            }
        }

        let currentMode = 'visual';
        let richEditor = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            document.getElementById('search-input').addEventListener('input', (e) => {
                filterSubscribers(e.target.value);
            });
            
            richEditor = document.getElementById('rich-html-editor');
        });
        let currentTemplate = '';
        
        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
            richEditor.focus();
        }
        
        function insertLink() {
            const url = prompt('Enter URL:');
            if (url) {
                formatDoc('createLink', url);
            }
        }

        function switchMode(mode) {
            const visualContainer = document.getElementById('editor-container-visual');
            const codeContainer = document.getElementById('editor-container-code');
            const codeTextarea = document.getElementById('campaign-content');
            
            // Get current content
            let content = '';
            if (currentMode === 'visual' && richEditor) {
                content = richEditor.innerHTML;
            } else {
                content = codeTextarea.value;
            }
            
            // Switch display
            if (mode === 'visual') {
                visualContainer.style.display = 'block';
                codeContainer.style.display = 'none';
                if (richEditor) {
                    if (currentMode === 'markdown' && content && !content.startsWith('<')) {
                        content = marked.parse(content);
                    }
                    const bodyMatch = content.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                    if (bodyMatch) {
                        content = bodyMatch[1];
                    }
                    richEditor.innerHTML = content;
                }
            } else if (mode === 'markdown') {
                visualContainer.style.display = 'none';
                codeContainer.style.display = 'block';
                // Convert HTML to markdown
                if (currentMode === 'visual') {
                    content = htmlToMarkdown(content);
                } else if (currentMode === 'html') {
                    // Extract body content if full HTML, then convert
                    const bodyMatch = content.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                    if (bodyMatch) {
                        content = htmlToMarkdown(bodyMatch[1]);
                    } else {
                        content = htmlToMarkdown(content);
                    }
                }
                codeTextarea.value = content;
            } else { // HTML mode
                visualContainer.style.display = 'none';
                codeContainer.style.display = 'block';
                // If switching from visual to HTML and we have a template, reconstruct full HTML
                if (currentMode === 'visual' && currentTemplate) {
                    const template = EMAIL_TEMPLATES[currentTemplate];
                    const bodyMatch = template.html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                    if (bodyMatch) {
                        content = template.html.replace(bodyMatch[1], content);
                    }
                } else if (currentMode === 'markdown') {
                    // Convert markdown to HTML
                    content = marked.parse(content);
                }
                codeTextarea.value = content;
            }
            
            currentMode = mode;
        }
        
        function htmlToMarkdown(html) {
            // Simple HTML to Markdown converter
            let md = html;
            
            // Headers
            md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
            md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
            md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
            
            // Bold and italic
            md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
            md = md.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
            md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
            md = md.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
            
            // Links
            md = md.replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
            
            // Lists
            md = md.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
            md = md.replace(/<\/ul>/gi, '\n');
            md = md.replace(/<\/ol>/gi, '\n');
            md = md.replace(/<ul[^>]*>/gi, '');
            md = md.replace(/<ol[^>]*>/gi, '');
            
            // Paragraphs
            md = md.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
            md = md.replace(/<br\s*\/?>/gi, '\n');
            
            // Remove remaining HTML tags
            md = md.replace(/<[^>]+>/g, '');
            
            // Clean up extra whitespace
            md = md.replace(/\n{3,}/g, '\n\n');
            md = md.trim();
            
            return md;
        }

        function loadTemplate() {
            const templateKey = document.getElementById('template-select').value;
            const previewBtn = document.getElementById('preview-template-btn');
            
            if (!templateKey) {
                if (quillEditor) quillEditor.root.innerHTML = '';
                document.getElementById('campaign-content').value = '';
                previewBtn.style.display = 'none';
                currentTemplate = '';
                return;
            }
            
            if (typeof EMAIL_TEMPLATES === 'undefined') {
                alert('Error: Email templates not loaded. Refresh the page.');
                return;
            }
            
            currentTemplate = templateKey;
            const template = EMAIL_TEMPLATES[templateKey];
            
            if (!template) {
                alert('Error: Template not found: ' + templateKey);
                return;
            }
            
            previewBtn.style.display = 'block';
            
            if (currentMode === 'visual') {
                const bodyMatch = template.html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                if (richEditor && bodyMatch) {
                    richEditor.innerHTML = bodyMatch[1];
                }
            } else if (currentMode === 'markdown') {
                const bodyMatch = template.html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                document.getElementById('campaign-content').value = htmlToMarkdown(bodyMatch ? bodyMatch[1] : template.html);
            } else {
                document.getElementById('campaign-content').value = template.html;
            }
        }
        
        function previewTemplate() {
            if (!currentTemplate) return;
            
            const template = EMAIL_TEMPLATES[currentTemplate];
            let content = template.html;
            
            // Replace placeholders with sample data
            content = content
                .replace(/{{TITLE}}/g, 'Sample Title - Replace This')
                .replace(/{{CONTENT}}/g, 'This is sample content. Replace this with your actual message.')
                .replace(/{{CTA_TEXT}}/g, 'Click Here')
                .replace(/{{CTA_LINK}}/g, 'https://christianconservativestoday.com/election-map.html')
                .replace(/{{PRAYER}}/g, 'Sample prayer text - replace with your prayer')
                .replace(/{{ACTION_STEPS}}/g, '1. First action step\n2. Second action step\n3. Third action step')
                .replace(/{{DATE}}/g, new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));
            
            const previewWindow = window.open('', 'Template Preview', 'width=700,height=800');
            previewWindow.document.write(content);
            previewWindow.document.close();
        }

        function previewEmail() {
            let content = '';
            
            // Get content based on current mode
            if (currentMode === 'visual' && richEditor) {
                content = richEditor.innerHTML;
                // If using a template, wrap content back in full HTML structure
                if (currentTemplate) {
                    const template = EMAIL_TEMPLATES[currentTemplate];
                    const bodyMatch = template.html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                    if (bodyMatch) {
                        content = template.html.replace(bodyMatch[1], content);
                    }
                } else {
                    // Wrap simple content in basic email structure
                    content = `
                    <!DOCTYPE html>
                    <html>
                    <head><meta charset="UTF-8"></head>
                    <body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        ${content}
                    </body>
                    </html>
                    `;
                }
            } else {
                content = document.getElementById('campaign-content').value;
                if (currentMode === 'markdown') {
                    const markdownContent = marked.parse(content);
                    content = `
                    <!DOCTYPE html>
                    <html>
                    <head><meta charset="UTF-8"></head>
                    <body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        ${markdownContent}
                    </body>
                    </html>
                    `;
                }
            }
            
            // Replace placeholders with sample data
            content = content
                .replace(/{{TITLE}}/g, 'Sample Title')
                .replace(/{{CONTENT}}/g, 'This is sample content for preview purposes.')
                .replace(/{{CTA_TEXT}}/g, 'Click Here')
                .replace(/{{CTA_LINK}}/g, 'https://christianconservativestoday.com/election-map.html')
                .replace(/{{PRAYER}}/g, 'Sample prayer text')
                .replace(/{{ACTION_STEPS}}/g, '1. Step one<br>2. Step two<br>3. Step three')
                .replace(/{{DATE}}/g, new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));
            
            const previewWindow = window.open('', 'Email Preview', 'width=700,height=800');
            previewWindow.document.write(content);
            previewWindow.document.close();
        }

        async function sendCampaign() {
            const campaignId = document.getElementById('campaign-id').value.trim();
            const subject = document.getElementById('campaign-subject').value.trim();
            let content = '';
            
            // Get content based on current mode
            if (currentMode === 'visual' && richEditor) {
                content = richEditor.innerHTML;
                // If using a template, wrap content back in full HTML structure
                if (currentTemplate) {
                    const template = EMAIL_TEMPLATES[currentTemplate];
                    const bodyMatch = template.html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
                    if (bodyMatch) {
                        content = template.html.replace(bodyMatch[1], content);
                    }
                }
            } else {
                content = document.getElementById('campaign-content').value.trim();
                if (currentMode === 'markdown') {
                    content = marked.parse(content);
                }
            }
            
            if (!campaignId || !subject || !content) {
                alert('Please fill in all fields');
                return;
            }
            
            if (!confirm(`Send campaign "${subject}" to all active subscribers?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/campaigns/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        campaign_id: campaignId,
                        subject: subject,
                        html_content: content
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úì Campaign sent!\n\nSent: ${result.sent}\nFailed: ${result.failed}`);
                    document.getElementById('campaign-id').value = '';
                    document.getElementById('campaign-subject').value = '';
                    document.getElementById('campaign-content').value = '';
                    loadAllData();
                } else {
                    alert('‚úó Failed to send campaign: ' + result.error);
                }
            } catch (error) {
                alert('‚úó Error sending campaign');
            }
        }
        
        function exportCSV() {
            const csv = [
                ['Email', 'Status', 'Subscribed', 'Source', 'Opens', 'Clicks', 'Last Activity'],
                ...allSubscribers.map(s => [
                    s.email,
                    s.status,
                    s.subscribed_at,
                    s.source || '',
                    s.total_opens || 0,
                    s.total_clicks || 0,
                    s.last_activity || ''
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subscribers_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>

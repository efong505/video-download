<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Contributors - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-bottom: 30px;
        }
        .navbar-custom .nav-link {
            color: white !important;
        }
        .navbar-custom .nav-link:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="admin.html">üó∫Ô∏è Contributors Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="admin.html">‚Üê Admin Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="election-map.html" target="_blank">View Public Map</a></li>
                    <li class="nav-item"><a class="nav-link" href="videos.html">Videos</a></li>
                    <li class="nav-item"><a class="nav-link" href="articles.html">Articles</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <h2>üó∫Ô∏è State Election Contributors Management</h2>
        
        <ul class="nav nav-tabs mt-4" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#contributors">Contributors</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#races">Races</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#candidates">Candidates</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#events">Events</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#import">Bulk Import</a></li>
        </ul>

        <div class="tab-content mt-3">
            <div id="contributors" class="tab-pane fade show active">
                <button class="btn btn-primary mb-3" onclick="showAddContributor()">+ Add Contributor</button>
                <div id="contributors-list"></div>
            </div>
            
            <div id="races" class="tab-pane fade">
                <button class="btn btn-primary mb-3" onclick="showAddRace()">+ Add Race</button>
                <div id="races-list"></div>
            </div>
            
            <div id="candidates" class="tab-pane fade">
                <button class="btn btn-primary mb-3" onclick="showAddCandidate()">+ Add Candidate</button>
                <div id="candidates-list"></div>
            </div>
            
            <div id="events" class="tab-pane fade">
                <button class="btn btn-primary mb-3" onclick="showAddEvent()">+ Add Event</button>
                <div id="events-list"></div>
            </div>
            
            <div id="import" class="tab-pane fade">
                <div class="alert alert-info">
                    <h5>CSV Bulk Import</h5>
                    <p>Upload CSV files to quickly import multiple races and candidates.</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Import Races</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>CSV Format:</strong> state, office, election_date, race_type, description</p>
                                <p><small>Example: Texas, Governor, 2024-11-05, general, Texas Gubernatorial Race</small></p>
                                <input type="file" class="form-control mb-2" id="races-csv" accept=".csv">
                                <button class="btn btn-primary" onclick="importRaces()">Import Races</button>
                                <a href="#" onclick="downloadRacesTemplate()" class="btn btn-outline-secondary">Download Template</a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Import Candidates</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>CSV Format:</strong> name, state, office, party, bio, website, faith_statement, positions, endorsements</p>
                                <p><small>Example: John Smith, Texas, Governor, Republican, Bio text, https://..., Faith statement, abortion:pro-life;guns:strong-support, NRA;Right to Life</small></p>
                                <input type="file" class="form-control mb-2" id="candidates-csv" accept=".csv">
                                <button class="btn btn-success" onclick="importCandidates()">Import Candidates</button>
                                <a href="#" onclick="downloadCandidatesTemplate()" class="btn btn-outline-secondary">Download Template</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="import-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="contributorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Contributor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="contributorForm">
                        <div class="mb-3">
                            <label>User Email</label>
                            <input type="email" class="form-control" id="contrib-email" required>
                        </div>
                        <div class="mb-3">
                            <label>State</label>
                            <select class="form-control" id="contrib-state" required></select>
                        </div>
                        <div class="mb-3">
                            <label>Bio</label>
                            <textarea class="form-control" id="contrib-bio" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label><input type="checkbox" id="contrib-verified"> Verified</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveContributor()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="candidateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Candidate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="candidateForm">
                        <div class="mb-3">
                            <label>Name</label>
                            <input type="text" class="form-control" id="cand-name" required>
                        </div>
                        <div class="mb-3">
                            <label>State</label>
                            <select class="form-control" id="cand-state" required></select>
                        </div>
                        <div class="mb-3">
                            <label>Race</label>
                            <select class="form-control" id="cand-race"></select>
                        </div>
                        <div class="mb-3">
                            <label>Office</label>
                            <input type="text" class="form-control" id="cand-office" placeholder="e.g., Governor, Senate" required>
                        </div>
                        <div class="mb-3">
                            <label>Bio</label>
                            <textarea class="form-control" id="cand-bio" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label>Faith Statement</label>
                            <textarea class="form-control" id="cand-faith" rows="2" placeholder="Candidate's statement of faith"></textarea>
                        </div>
                        <div class="mb-3">
                            <label>Website</label>
                            <input type="url" class="form-control" id="cand-website">
                        </div>
                        <div class="mb-3">
                            <label>Voting Record URL</label>
                            <input type="url" class="form-control" id="cand-voting-record">
                        </div>
                        <div class="mb-3">
                            <label>Endorsements (comma-separated)</label>
                            <input type="text" class="form-control" id="cand-endorsements" placeholder="e.g., NRA, Right to Life">
                        </div>
                        <hr>
                        <h6>Policy Positions</h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label>Abortion</label>
                                <select class="form-control" id="pos-abortion">
                                    <option value="">Not specified</option>
                                    <option value="pro-life">Pro-Life</option>
                                    <option value="pro-choice">Pro-Choice</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>2nd Amendment</label>
                                <select class="form-control" id="pos-guns">
                                    <option value="">Not specified</option>
                                    <option value="strong-support">Strong Support</option>
                                    <option value="support">Support</option>
                                    <option value="restrictions">Support Restrictions</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Immigration</label>
                                <select class="form-control" id="pos-immigration">
                                    <option value="">Not specified</option>
                                    <option value="secure-border">Secure Border</option>
                                    <option value="pathway">Pathway to Citizenship</option>
                                    <option value="enforcement">Strict Enforcement</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Religious Freedom</label>
                                <select class="form-control" id="pos-religious-freedom">
                                    <option value="">Not specified</option>
                                    <option value="strong-support">Strong Support</option>
                                    <option value="support">Support</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Taxes</label>
                                <select class="form-control" id="pos-taxes">
                                    <option value="">Not specified</option>
                                    <option value="lower">Lower Taxes</option>
                                    <option value="flat-tax">Flat Tax</option>
                                    <option value="current">Maintain Current</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label>Education</label>
                                <select class="form-control" id="pos-education">
                                    <option value="">Not specified</option>
                                    <option value="school-choice">School Choice</option>
                                    <option value="parental-rights">Parental Rights</option>
                                    <option value="public-schools">Support Public Schools</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCandidate()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="raceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Race</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="raceForm">
                        <div class="mb-3">
                            <label>State</label>
                            <select class="form-control" id="race-state" required></select>
                        </div>
                        <div class="mb-3">
                            <label>Office</label>
                            <input type="text" class="form-control" id="race-office" placeholder="e.g., Governor, U.S. Senate" required>
                        </div>
                        <div class="mb-3">
                            <label>Election Date</label>
                            <input type="date" class="form-control" id="race-date" required>
                        </div>
                        <div class="mb-3">
                            <label>Race Type</label>
                            <select class="form-control" id="race-type">
                                <option value="primary">Primary</option>
                                <option value="general">General Election</option>
                                <option value="special">Special Election</option>
                                <option value="runoff">Runoff</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Description</label>
                            <textarea class="form-control" id="race-desc" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRace()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Election Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <div class="mb-3">
                            <label>Title</label>
                            <input type="text" class="form-control" id="event-title" required>
                        </div>
                        <div class="mb-3">
                            <label>State</label>
                            <select class="form-control" id="event-state" required></select>
                        </div>
                        <div class="mb-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="event-date" required>
                        </div>
                        <div class="mb-3">
                            <label>Type</label>
                            <select class="form-control" id="event-type">
                                <option value="primary">Primary</option>
                                <option value="general">General Election</option>
                                <option value="debate">Debate</option>
                                <option value="rally">Rally</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Description</label>
                            <textarea class="form-control" id="event-desc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEvent()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = 'https://hzursivfuk.execute-api.us-east-1.amazonaws.com/prod/contributors';
        const states = ['Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming'];

        let allRaces = [];
        
        function populateStateDropdowns() {
            ['contrib-state', 'cand-state', 'event-state', 'race-state'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">Select State</option>' + states.map(s => '<option value="' + s + '">' + s + '</option>').join('');
            });
        }
        
        function populateRaceDropdown() {
            const select = document.getElementById('cand-race');
            select.innerHTML = '<option value="">No Race (Optional)</option>' + allRaces.map(r => 
                '<option value="' + r.race_id + '">' + r.state + ' - ' + r.office + ' (' + r.race_type + ')</option>'
            ).join('');
        }

        async function loadContributors() {
            const response = await fetch(API + '?resource=contributors', {headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}});
            const data = await response.json();
            document.getElementById('contributors-list').innerHTML = data.map(c => 
                '<div class="card mb-2"><div class="card-body">' +
                '<h6>' + c.user_email + ' - ' + c.state + '</h6>' +
                '<p>' + (c.bio || '') + '</p>' +
                '<span class="badge bg-' + (c.verified ? 'success' : 'secondary') + '">' + (c.verified ? 'Verified' : 'Unverified') + '</span>' +
                '<button class="btn btn-sm btn-danger float-end" onclick="deleteContributor(\'' + c.contributor_id + '\')">Delete</button>' +
                '</div></div>'
            ).join('');
        }

        async function loadRaces() {
            const response = await fetch(API + '?resource=races', {headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}});
            allRaces = await response.json();
            document.getElementById('races-list').innerHTML = allRaces.map(r => 
                '<div class="card mb-2"><div class="card-body">' +
                '<h6>' + r.state + ' - ' + r.office + '</h6>' +
                '<p><strong>' + r.race_type + '</strong> - ' + new Date(r.election_date).toLocaleDateString() + '</p>' +
                '<p>' + (r.description || '') + '</p>' +
                '<button class="btn btn-sm btn-danger float-end" onclick="deleteRace(\'' + r.race_id + '\')">Delete</button>' +
                '</div></div>'
            ).join('');
            populateRaceDropdown();
        }
        
        async function loadCandidates() {
            const response = await fetch(API + '?resource=candidates', {headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}});
            const data = await response.json();
            document.getElementById('candidates-list').innerHTML = data.map(c => {
                const race = allRaces.find(r => r.race_id === c.race_id);
                const positions = c.positions || {};
                return '<div class="card mb-2"><div class="card-body">' +
                '<h6>' + c.name + ' - ' + c.state + '</h6>' +
                '<p><strong>' + c.office + '</strong>' + (race ? ' (' + race.race_type + ')' : '') + '</p>' +
                '<p>' + (c.bio || '') + '</p>' +
                (c.faith_statement ? '<p class="text-muted"><em>"' + c.faith_statement + '"</em></p>' : '') +
                (Object.keys(positions).length > 0 ? '<p><small><strong>Positions:</strong> ' + Object.entries(positions).map(([k,v]) => k + ': ' + v).join(', ') + '</small></p>' : '') +
                '<button class="btn btn-sm btn-danger float-end" onclick="deleteCandidate(\'' + c.candidate_id + '\')">Delete</button>' +
                '</div></div>';
            }).join('');
        }

        async function loadEvents() {
            const response = await fetch(API + '?resource=events', {headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}});
            const data = await response.json();
            document.getElementById('events-list').innerHTML = data.map(e => 
                '<div class="card mb-2"><div class="card-body">' +
                '<h6>' + e.title + ' - ' + e.state + '</h6>' +
                '<p>' + new Date(e.event_date).toLocaleDateString() + ' - ' + e.event_type + '</p>' +
                '<button class="btn btn-sm btn-danger float-end" onclick="deleteEvent(\'' + e.event_id + '\')">Delete</button>' +
                '</div></div>'
            ).join('');
        }

        function showAddContributor() {
            new bootstrap.Modal(document.getElementById('contributorModal')).show();
        }

        function showAddRace() {
            new bootstrap.Modal(document.getElementById('raceModal')).show();
        }
        
        function showAddCandidate() {
            new bootstrap.Modal(document.getElementById('candidateModal')).show();
        }

        function showAddEvent() {
            new bootstrap.Modal(document.getElementById('eventModal')).show();
        }

        async function saveContributor() {
            const data = {
                user_email: document.getElementById('contrib-email').value,
                state: document.getElementById('contrib-state').value,
                bio: document.getElementById('contrib-bio').value,
                verified: document.getElementById('contrib-verified').checked
            };
            
            await fetch(API + '?resource=contributors', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('auth_token')},
                body: JSON.stringify(data)
            });
            
            bootstrap.Modal.getInstance(document.getElementById('contributorModal')).hide();
            loadContributors();
        }

        async function saveRace() {
            const data = {
                state: document.getElementById('race-state').value,
                office: document.getElementById('race-office').value,
                election_date: document.getElementById('race-date').value,
                race_type: document.getElementById('race-type').value,
                description: document.getElementById('race-desc').value
            };
            
            await fetch(API + '?resource=races', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('auth_token')},
                body: JSON.stringify(data)
            });
            
            bootstrap.Modal.getInstance(document.getElementById('raceModal')).hide();
            loadRaces();
        }
        
        async function saveCandidate() {
            const positions = {
                abortion: document.getElementById('pos-abortion').value,
                guns: document.getElementById('pos-guns').value,
                immigration: document.getElementById('pos-immigration').value,
                religious_freedom: document.getElementById('pos-religious-freedom').value,
                taxes: document.getElementById('pos-taxes').value,
                education: document.getElementById('pos-education').value
            };
            Object.keys(positions).forEach(k => !positions[k] && delete positions[k]);
            
            const endorsements = document.getElementById('cand-endorsements').value
                .split(',').map(e => e.trim()).filter(e => e);
            
            const data = {
                name: document.getElementById('cand-name').value,
                state: document.getElementById('cand-state').value,
                office: document.getElementById('cand-office').value,
                bio: document.getElementById('cand-bio').value,
                website: document.getElementById('cand-website').value,
                race_id: document.getElementById('cand-race').value,
                faith_statement: document.getElementById('cand-faith').value,
                voting_record_url: document.getElementById('cand-voting-record').value,
                positions: positions,
                endorsements: endorsements
            };
            
            await fetch(API + '?resource=candidates', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('auth_token')},
                body: JSON.stringify(data)
            });
            
            bootstrap.Modal.getInstance(document.getElementById('candidateModal')).hide();
            loadCandidates();
        }

        async function saveEvent() {
            const data = {
                title: document.getElementById('event-title').value,
                state: document.getElementById('event-state').value,
                event_date: document.getElementById('event-date').value,
                event_type: document.getElementById('event-type').value,
                description: document.getElementById('event-desc').value
            };
            
            await fetch(API + '?resource=events', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('auth_token')},
                body: JSON.stringify(data)
            });
            
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            loadEvents();
        }

        async function deleteContributor(id) {
            if (!confirm('Delete this contributor?')) return;
            await fetch(API + '?resource=contributors&action=delete&contributor_id=' + id, {
                method: 'DELETE',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}
            });
            loadContributors();
        }

        async function deleteCandidate(id) {
            if (!confirm('Delete this candidate?')) return;
            await fetch(API + '?resource=candidates&action=delete&candidate_id=' + id, {
                method: 'DELETE',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}
            });
            loadCandidates();
        }

        async function deleteRace(id) {
            if (!confirm('Delete this race?')) return;
            await fetch(API + '?resource=races&action=delete&race_id=' + id, {
                method: 'DELETE',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}
            });
            loadRaces();
        }
        
        async function deleteEvent(id) {
            if (!confirm('Delete this event?')) return;
            await fetch(API + '?resource=events&action=delete&event_id=' + id, {
                method: 'DELETE',
                headers: {'Authorization': 'Bearer ' + localStorage.getItem('auth_token')}
            });
            loadEvents();
        }

        function downloadRacesTemplate() {
            const csv = 'state,office,election_date,race_type,description\nTexas,Governor,2024-11-05,general,Texas Gubernatorial Race\nCalifornia,Senate,2024-11-05,general,U.S. Senate Race';
            downloadCSV(csv, 'races_template.csv');
        }
        
        function downloadCandidatesTemplate() {
            const csv = 'name,state,office,party,bio,website,faith_statement,positions,endorsements\nJohn Smith,Texas,Governor,Republican,Conservative leader,https://example.com,Christian values,abortion:pro-life;guns:strong-support,NRA;Right to Life';
            downloadCSV(csv, 'candidates_template.csv');
        }
        
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        async function importRaces() {
            const file = document.getElementById('races-csv').files[0];
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            const text = await file.text();
            const lines = text.split('\n').slice(1); // Skip header
            let imported = 0;
            let errors = [];
            
            for (const line of lines) {
                if (!line.trim()) continue;
                const [state, office, election_date, race_type, description] = line.split(',').map(s => s.trim());
                
                try {
                    await fetch(API + '?resource=races', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('auth_token')},
                        body: JSON.stringify({ state, office, election_date, race_type, description })
                    });
                    imported++;
                } catch (error) {
                    errors.push(`Failed to import: ${state} - ${office}`);
                }
            }
            
            document.getElementById('import-status').innerHTML = 
                '<div class="alert alert-success">Imported ' + imported + ' races. ' + (errors.length > 0 ? errors.length + ' errors.' : '') + '</div>';
            loadRaces();
        }
        
        async function importCandidates() {
            const file = document.getElementById('candidates-csv').files[0];
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            const text = await file.text();
            const lines = text.split('\n').slice(1); // Skip header
            let imported = 0;
            let errors = [];
            
            for (const line of lines) {
                if (!line.trim()) continue;
                const parts = line.split(',').map(s => s.trim());
                const [name, state, office, party, bio, website, faith_statement, positionsStr, endorsementsStr] = parts;
                
                const positions = {};
                if (positionsStr) {
                    positionsStr.split(';').forEach(p => {
                        const [key, value] = p.split(':');
                        if (key && value) positions[key.trim()] = value.trim();
                    });
                }
                
                const endorsements = endorsementsStr ? endorsementsStr.split(';').map(e => e.trim()) : [];
                
                // Auto-match race by state and office
                const matchingRace = allRaces.find(r => r.state === state && r.office === office);
                const race_id = matchingRace ? matchingRace.race_id : null;
                
                try {
                    await fetch(API + '?resource=candidates', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('auth_token')},
                        body: JSON.stringify({ name, state, office, party, bio, website, faith_statement, positions, endorsements, race_id })
                    });
                    imported++;
                } catch (error) {
                    errors.push(`Failed to import: ${name}`);
                }
            }
            
            document.getElementById('import-status').innerHTML = 
                '<div class="alert alert-success">Imported ' + imported + ' candidates. ' + (errors.length > 0 ? errors.length + ' errors.' : '') + '</div>';
            loadCandidates();
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            populateStateDropdowns();
            loadContributors();
            await loadRaces();
            loadCandidates();
            loadEvents();
        });
    </script>
</body>
</html>

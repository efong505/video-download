<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekewaka Videos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .dashboard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .nav-brand {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0;
        }
        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .nav-link.logout {
            background: rgba(220,53,69,0.8);
            border-color: rgba(220,53,69,0.9);
        }
        .nav-link.logout:hover {
            background: rgba(220,53,69,1);
        }
        .video-card {
            position: relative;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            background: white;
        }
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .thumbnail-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: #000;
            overflow: hidden;
        }
        .thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102,126,234,0.9);
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .play-button:hover {
            background: rgba(102,126,234,1);
            transform: translate(-50%, -50%) scale(1.1);
        }
        .video-player {
            display: none;
            width: 100%;
            height: 200px;
        }
        .video-title {
            padding: 15px;
            background: white;
            font-weight: 600;
            text-align: center;
            color: #333;
            border-top: 1px solid #eee;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .content-wrapper {
            background: #f8f9fa;
            min-height: calc(100vh - 200px);
            padding: 30px 0;
        }
        .stats-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1 class="nav-brand">üé¨ Video Gallery</h1>
                <div class="nav-links" id="nav-links">
                    <a href="/" class="nav-link">üè† Home</a>
                    <a href="category.html" class="nav-link">üìÇ Categories</a>
                    <a href="profile.html" class="nav-link">üë§ Profile</a>
                    <a href="#" onclick="logout()" class="nav-link logout">üö™ Logout</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="content-wrapper">
        <div class="container">
            <div class="stats-bar" id="stats-bar" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="total-videos">0</div>
                    <div class="stat-label">Total Videos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-size">0 GB</div>
                    <div class="stat-label">Total Size</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-tags">0</div>
                    <div class="stat-label">Unique Tags</div>
                </div>
            </div>
        
        <div id="loading" class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading videos...</p>
        </div>
        
            <div class="search-filter-bar" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: none;" id="search-filter-bar">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" id="search-input" class="form-control" placeholder="Search videos by title or filename..." style="border-radius: 25px;">
                    </div>
                    <div class="col-md-4">
                        <select id="tag-filter" class="form-select" style="border-radius: 25px;">
                            <option value="">All Tags</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary" onclick="clearFilters()" style="border-radius: 25px; width: 100%;">Clear</button>
                    </div>
                </div>
            </div>
            
            <div id="videos-container" class="row g-4" style="display: none;">
                <!-- Videos will be loaded here dynamically -->
            </div>
            
            <div id="no-videos" class="text-center" style="display: none;">
                <p>No videos found.</p>
            </div>
        </div>
    </div>

    <script>
        const BUCKET_URL = 'https://d271vky579caz9.cloudfront.net';
        const AUTH_API = 'https://r6l0z3605f.execute-api.us-east-1.amazonaws.com/prod/auth';
        const TAG_API = 'https://h4hoegi26b.execute-api.us-east-1.amazonaws.com/prod/tags';
        
        let allVideos = [];
        let filteredVideos = [];
        
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                // No token, redirect to login
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                // Verify token with server
                const response = await fetch(`${AUTH_API}?action=verify`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Invalid token, redirect to login
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_data');
                    window.location.href = 'login.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                // On error, redirect to login
                window.location.href = 'login.html';
                return false;
            }
        }
        
        async function loadVideos() {
            try {
                // Fetch video list dynamically from API
                const response = await fetch('https://wfeds5lejb.execute-api.us-east-1.amazonaws.com/prod/api/videos');
                const data = await response.json();
                
                console.log('Video list API response:', data);
                
                const container = document.getElementById('videos-container');
                
                if (data.videos && data.videos.length > 0) {
                    // Simplified approach: just use the video list and create basic titles
                    // This ensures videos show up even if metadata is missing
                    let videosWithMetadata = data.videos.map(video => ({
                        ...video,
                        title: video.filename.replace('.mp4', '').replace(/_/g, ' '),
                        tags: []
                    }));
                    
                    // Try to enhance with metadata from admin API if available
                    try {
                        const adminResponse = await fetch(`https://k2avuckm38.execute-api.us-east-1.amazonaws.com/prod/admin?action=videos`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                        });
                        
                        if (adminResponse.ok) {
                            const adminData = await adminResponse.json();
                            console.log('Admin API response:', adminData);
                            
                            if (adminData.videos) {
                                const adminVideoMap = new Map();
                                adminData.videos.forEach(adminVideo => {
                                    adminVideoMap.set(adminVideo.filename, adminVideo);
                                });
                                
                                videosWithMetadata = data.videos.map(video => {
                                    const adminVideo = adminVideoMap.get(video.filename);
                                    return {
                                        ...video,
                                        title: adminVideo ? adminVideo.title : video.filename.replace('.mp4', '').replace(/_/g, ' '),
                                        tags: adminVideo ? adminVideo.tags : []
                                    };
                                });
                            }
                        } else {
                            // Fallback to TAG API for regular users
                            const tagResponse = await fetch(`${TAG_API}?action=list`);
                            if (tagResponse.ok) {
                                const tagData = await tagResponse.json();
                                
                                if (tagData.videos) {
                                    const tagVideoMap = new Map();
                                    tagData.videos.forEach(tagVideo => {
                                        tagVideoMap.set(tagVideo.filename, tagVideo);
                                    });
                                    
                                    videosWithMetadata = data.videos.map(video => {
                                        const tagVideo = tagVideoMap.get(video.filename);
                                        return {
                                            ...video,
                                            title: tagVideo ? tagVideo.title : video.filename.replace('.mp4', '').replace(/_/g, ' '),
                                            tags: tagVideo ? tagVideo.tags : []
                                        };
                                    });
                                }
                            }
                        }
                    } catch (error) {
                        // Fallback to TAG API for regular users
                        try {
                            const tagResponse = await fetch(`${TAG_API}?action=list`);
                            if (tagResponse.ok) {
                                const tagData = await tagResponse.json();
                                
                                if (tagData.videos) {
                                    const tagVideoMap = new Map();
                                    tagData.videos.forEach(tagVideo => {
                                        tagVideoMap.set(tagVideo.filename, tagVideo);
                                    });
                                    
                                    videosWithMetadata = data.videos.map(video => {
                                        const tagVideo = tagVideoMap.get(video.filename);
                                        return {
                                            ...video,
                                            title: tagVideo ? tagVideo.title : video.filename.replace('.mp4', '').replace(/_/g, ' '),
                                            tags: tagVideo ? tagVideo.tags : []
                                        };
                                    });
                                }
                            }
                        } catch (tagError) {
                            // Use basic titles if both APIs fail
                        }
                    }
                    // Calculate statistics
                    const totalSize = videosWithMetadata.reduce((sum, video) => sum + (video.size || 0), 0);
                    const allTags = new Set();
                    videosWithMetadata.forEach(video => {
                        if (video.tags) {
                            video.tags.forEach(tag => allTags.add(tag));
                        }
                    });
                    
                    // Update stats
                    document.getElementById('total-videos').textContent = videosWithMetadata.length;
                    document.getElementById('total-size').textContent = (totalSize / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
                    document.getElementById('total-tags').textContent = allTags.size;
                    document.getElementById('stats-bar').style.display = 'flex';
                    
                    // Store videos for filtering
                    allVideos = videosWithMetadata;
                    filteredVideos = [...allVideos];
                    
                    // Setup tag filter options
                    setupTagFilter(allTags);
                    
                    // Setup search functionality
                    setupSearch();
                    
                    // Display videos
                    displayVideos(filteredVideos);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('videos-container').style.display = 'flex';
                    document.getElementById('search-filter-bar').style.display = 'block';
                } else {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('no-videos').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading videos:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-videos').style.display = 'block';
            }
        }
        
        function createVideoCard(container, title, videoUrl, thumbnailUrl, fallbackThumbnailUrl) {
            const col = document.createElement('div');
            col.className = 'col-md-4';
            
            col.innerHTML = `
                <div class="video-card">
                    <div class="thumbnail-container">
                        <img src="${thumbnailUrl}" alt="${title}" class="thumbnail" 
                             onerror="this.onerror=null; this.src='${fallbackThumbnailUrl}'; this.addEventListener('error', function(){this.style.display='none'; this.nextElementSibling.style.display='flex';});">
                        <div class="thumbnail" style="display: none; background: linear-gradient(135deg, #667eea, #764ba2); color: white; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">
                            üìπ ${title.substring(0,20)}${title.length > 20 ? '...' : ''}
                        </div>
                        <button class="play-button" onclick="playVideo(this, '${videoUrl}')">
                            ‚ñ∂
                        </button>
                        <video class="video-player" controls style="display: none;">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <div class="video-title">${title}</div>
                </div>
            `;
            
            container.appendChild(col);
        }
        
        function playVideo(button, videoUrl) {
            console.log('Playing video:', videoUrl);
            const card = button.closest('.video-card');
            const thumbnail = card.querySelector('.thumbnail');
            const playBtn = card.querySelector('.play-button');
            const video = card.querySelector('.video-player');
            
            // Hide thumbnail and play button
            thumbnail.style.display = 'none';
            playBtn.style.display = 'none';
            
            // Show and play video - use same approach as admin dashboard
            video.style.display = 'block';
            
            // Clear any existing sources and force reload (like admin dashboard)
            video.pause();
            video.src = '';
            video.load();
            
            // Set CloudFront URL and reload
            video.src = videoUrl;
            video.load();
            
            // Add error handling
            video.addEventListener('error', function(e) {
                console.error('Video error:', e, video.error);
                console.error('Failed URL:', videoUrl);
                // Show thumbnail again on error
                thumbnail.style.display = 'block';
                playBtn.style.display = 'block';
                video.style.display = 'none';
            });
            
            // Try to play
            video.play().catch(error => {
                console.error('Play error:', error);
                console.error('Failed URL:', videoUrl);
            });
            
            // When video ends, show thumbnail again
            video.addEventListener('ended', function() {
                thumbnail.style.display = 'block';
                playBtn.style.display = 'block';
                video.style.display = 'none';
            });
            
            // Handle pause to show thumbnail
            video.addEventListener('pause', function() {
                if (video.currentTime === 0 || video.ended) {
                    thumbnail.style.display = 'block';
                    playBtn.style.display = 'block';
                    video.style.display = 'none';
                }
            });
        }
        
        function setupTagFilter(allTags) {
            const tagFilter = document.getElementById('tag-filter');
            tagFilter.innerHTML = '<option value="">All Tags</option>';
            
            Array.from(allTags).sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });
            
            tagFilter.addEventListener('change', applyFilters);
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', applyFilters);
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const selectedTag = document.getElementById('tag-filter').value;
            
            filteredVideos = allVideos.filter(video => {
                const matchesSearch = !searchTerm || 
                    video.title.toLowerCase().includes(searchTerm) || 
                    video.filename.toLowerCase().includes(searchTerm);
                
                const matchesTag = !selectedTag || video.tags.includes(selectedTag);
                
                return matchesSearch && matchesTag;
            });
            
            displayVideos(filteredVideos);
        }
        
        function displayVideos(videos) {
            const container = document.getElementById('videos-container');
            container.innerHTML = '';
            
            for (const video of videos) {
                const baseName = video.filename.replace('.mp4', '');
                const videoUrl = `${BUCKET_URL}/videos/${video.filename}`;
                const thumbnailUrl = `${BUCKET_URL}/thumbnails/${baseName}_thumb_2.jpg`;
                const fallbackThumbnailUrl = `${BUCKET_URL}/thumbnails/${baseName}_thumb.jpg`;
                
                createVideoCard(container, video.title, videoUrl, thumbnailUrl, fallbackThumbnailUrl);
            }
        }
        
        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('tag-filter').value = '';
            applyFilters();
        }
        
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }
        

        
        // Check auth and load videos when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                // Check if user is admin and add admin link
                const userData = localStorage.getItem('user_data');
                if (userData) {
                    const user = JSON.parse(userData);
                    if (user.role === 'admin' || user.role === 'super_user') {
                        const navLinks = document.getElementById('nav-links');
                        const adminLink = document.createElement('a');
                        adminLink.href = 'admin.html';
                        adminLink.className = 'nav-link';
                        adminLink.textContent = '‚öôÔ∏è Admin Dashboard';
                        navLinks.insertBefore(adminLink, navLinks.lastElementChild);
                    }
                }
                loadVideos();
            }
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Analytics - Christian Conservatives Today</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/common-styles.css" rel="stylesheet">
    <style>
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .stat-number {
            font-size: 3rem;
            font-weight: bold;
        }
        .video-row {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .video-row:hover {
            background: #f8f9fa;
        }
        .video-row:last-child {
            border-bottom: none;
        }
        .progress {
            height: 25px;
        }
    </style>
</head>
<body>
    <div id="navbar-container" data-page="video-analytics"></div>

    <div class="container my-5" style="margin-top: 5rem !important;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>ðŸ“Š Video Analytics Dashboard</h1>
            <select id="dateRange" class="form-select" style="width: 200px;">
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="all" selected>All Time</option>
            </select>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Total Views</div>
                    <div class="stat-number" id="totalViews">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Total Videos</div>
                    <div class="stat-number" id="totalVideos">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Avg Views/Video</div>
                    <div class="stat-number" id="avgViews">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Videos with Views</div>
                    <div class="stat-number" id="videosWithViews">0</div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>ðŸ”¥ Top 10 Videos</h3>
                    </div>
                    <div class="card-body">
                        <div id="topVideos"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>ðŸ“ˆ Trending (Last 7 Days)</h3>
                    </div>
                    <div class="card-body">
                        <div id="trendingVideos"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h3>ðŸ“‚ Views by Category</h3>
            </div>
            <div class="card-body">
                <div id="categoryBreakdown"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="navbar.js"></script>
    <script>
        const TAG_API = 'https://diz6ceeb22.execute-api.us-east-1.amazonaws.com/prod/tags';

        fetch('navbar.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('navbar-container').innerHTML = html;
                initNavbar();
            });

        async function loadAnalytics() {
            try {
                const response = await fetch(TAG_API + '?action=analytics');
                const data = await response.json();
                
                const allResponse = await fetch(TAG_API + '?action=list');
                const allData = await allResponse.json();
                
                const totalVideos = allData.total_count || 0;
                const totalViews = data.top_videos.reduce((sum, v) => sum + v.view_count, 0);
                const videosWithViews = data.top_videos.filter(v => v.view_count > 0).length;
                const avgViews = videosWithViews > 0 ? Math.round(totalViews / videosWithViews) : 0;
                
                document.getElementById('totalViews').textContent = totalViews.toLocaleString();
                document.getElementById('totalVideos').textContent = totalVideos.toLocaleString();
                document.getElementById('avgViews').textContent = avgViews.toLocaleString();
                document.getElementById('videosWithViews').textContent = videosWithViews.toLocaleString();
                
                // Top videos
                const topVideosHtml = data.top_videos.slice(0, 10).map((video, index) => `
                    <div class="video-row">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>#${index + 1}</strong> ${video.title}
                            </div>
                            <div>
                                <span class="badge bg-primary">${video.view_count} views</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('topVideos').innerHTML = topVideosHtml || '<p class="text-muted">No views yet</p>';
                
                // Trending (simulate - would need date-based queries in production)
                const trending = data.top_videos.slice(0, 5);
                const trendingHtml = trending.map((video, index) => `
                    <div class="video-row">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>#${index + 1}</strong> ${video.title}
                            </div>
                            <div>
                                <span class="badge bg-success">${video.view_count} views</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('trendingVideos').innerHTML = trendingHtml || '<p class="text-muted">No trending data</p>';
                
                // Category breakdown
                const categoryViews = {};
                allData.videos.forEach(video => {
                    const category = video.tags && video.tags[0] ? video.tags[0] : 'Uncategorized';
                    const views = video.view_count || 0;
                    categoryViews[category] = (categoryViews[category] || 0) + views;
                });
                
                const sortedCategories = Object.entries(categoryViews)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                const categoryHtml = sortedCategories.map(([cat, views]) => {
                    const percentage = totalViews > 0 ? Math.round((views / totalViews) * 100) : 0;
                    return `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>${cat}</strong></span>
                                <span>${views} views (${percentage}%)</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('categoryBreakdown').innerHTML = categoryHtml || '<p class="text-muted">No category data</p>';
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('topVideos').innerHTML = '<p class="text-danger">Error loading analytics</p>';
            }
        }

        loadAnalytics();
        
        document.getElementById('dateRange').addEventListener('change', loadAnalytics);
    </script>
</body>
</html>

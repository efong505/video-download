<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Campaigns - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .campaign-card { margin-bottom: 15px; cursor: pointer; }
        .campaign-card:hover { background-color: #f8f9fa; }
        #editor { height: 300px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">Email Marketing - Campaigns</span>
            <a href="admin.html" class="btn btn-outline-light btn-sm">Back to Admin</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="mb-3">
            <button class="btn btn-primary" onclick="showCreateCampaign()">Create Campaign</button>
            <select id="statusFilter" class="form-select d-inline-block w-auto ms-3" onchange="loadCampaigns()">
                <option value="">All Campaigns</option>
                <option value="draft">Drafts</option>
                <option value="scheduled">Scheduled</option>
                <option value="sending">Sending</option>
                <option value="sent">Sent</option>
            </select>
        </div>

        <div id="campaignsList"></div>
    </div>

    <!-- Create/Edit Campaign Modal -->
    <div class="modal fade" id="campaignModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="campaignId">
                    
                    <div class="mb-3">
                        <label class="form-label">Campaign Title *</label>
                        <input type="text" id="campaignTitle" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email Subject *</label>
                        <input type="text" id="campaignSubject" class="form-control" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">From Name</label>
                            <input type="text" id="fromName" class="form-control" value="Christian Conservatives Today">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">From Email</label>
                            <input type="email" id="fromEmail" class="form-control" value="newsletter@christianconservativestoday.com">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email Content</label>
                        <div id="editor"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Send To</label>
                        <select id="segment" class="form-select">
                            <option value="all">All Active Subscribers</option>
                            <option value="tagged">Tagged Subscribers</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="sendTestEmail()">Send Test</button>
                    <button type="button" class="btn btn-success" onclick="saveCampaign('draft')">Save Draft</button>
                    <button type="button" class="btn btn-primary" onclick="sendCampaign()">Send Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Campaign Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statsContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const API_URL = 'YOUR-API-GATEWAY-URL/email-campaigns';
        const TRACKING_API_URL = 'YOUR-API-GATEWAY-URL/email-tracking';
        let quill;

        // Initialize Quill editor
        document.addEventListener('DOMContentLoaded', () => {
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        ['link', 'image'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
            
            loadCampaigns();
        });

        async function loadCampaigns() {
            const status = document.getElementById('statusFilter').value;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'list', status: status, limit: 50 })
                });
                
                const data = await response.json();
                displayCampaigns(data.campaigns || []);
            } catch (error) {
                console.error('Error loading campaigns:', error);
                alert('Failed to load campaigns');
            }
        }

        function displayCampaigns(campaigns) {
            const html = campaigns.map(camp => `
                <div class="card campaign-card" onclick="viewCampaign('${camp.campaign_id}')">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <strong>${camp.title}</strong><br>
                                <small class="text-muted">${camp.subject}</small>
                            </div>
                            <div class="col-md-2">
                                <span class="badge ${getStatusBadge(camp.status)}">${camp.status}</span>
                            </div>
                            <div class="col-md-3">
                                ${camp.status === 'sent' ? `
                                    <small>
                                        üìß ${camp.recipient_count || 0} sent<br>
                                        üìñ ${camp.open_count || 0} opens (${calculateRate(camp.open_count, camp.recipient_count)}%)<br>
                                        üñ±Ô∏è ${camp.click_count || 0} clicks (${calculateRate(camp.click_count, camp.recipient_count)}%)
                                    </small>
                                ` : `<small class="text-muted">${camp.created_at ? new Date(camp.created_at).toLocaleDateString() : ''}</small>`}
                            </div>
                            <div class="col-md-2 text-end">
                                ${camp.status === 'sent' ? 
                                    `<button class="btn btn-sm btn-info" onclick="event.stopPropagation(); showStats('${camp.campaign_id}')">Stats</button>` :
                                    `<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editCampaign('${camp.campaign_id}')">Edit</button>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('campaignsList').innerHTML = html || '<p class="text-muted">No campaigns found</p>';
        }

        function getStatusBadge(status) {
            const badges = {
                'draft': 'bg-secondary',
                'scheduled': 'bg-warning',
                'sending': 'bg-info',
                'sent': 'bg-success'
            };
            return badges[status] || 'bg-secondary';
        }

        function calculateRate(count, total) {
            return total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        }

        function showCreateCampaign() {
            document.getElementById('modalTitle').textContent = 'Create Campaign';
            document.getElementById('campaignId').value = '';
            document.getElementById('campaignTitle').value = '';
            document.getElementById('campaignSubject').value = '';
            quill.setContents([]);
            new bootstrap.Modal(document.getElementById('campaignModal')).show();
        }

        async function editCampaign(campaignId) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get', campaign_id: campaignId })
                });
                
                const data = await response.json();
                const campaign = data.campaign;
                
                document.getElementById('modalTitle').textContent = 'Edit Campaign';
                document.getElementById('campaignId').value = campaign.campaign_id;
                document.getElementById('campaignTitle').value = campaign.title;
                document.getElementById('campaignSubject').value = campaign.subject;
                document.getElementById('fromName').value = campaign.from_name;
                document.getElementById('fromEmail').value = campaign.from_email;
                document.getElementById('segment').value = campaign.segment;
                
                // Set Quill content
                quill.root.innerHTML = campaign.content_html;
                
                new bootstrap.Modal(document.getElementById('campaignModal')).show();
            } catch (error) {
                console.error('Error loading campaign:', error);
                alert('Failed to load campaign');
            }
        }

        async function saveCampaign(status = 'draft') {
            const campaignId = document.getElementById('campaignId').value;
            const title = document.getElementById('campaignTitle').value;
            const subject = document.getElementById('campaignSubject').value;
            const fromName = document.getElementById('fromName').value;
            const fromEmail = document.getElementById('fromEmail').value;
            const segment = document.getElementById('segment').value;
            const contentHtml = quill.root.innerHTML;
            
            if (!title || !subject) {
                alert('Title and subject are required');
                return;
            }
            
            try {
                const action = campaignId ? 'update' : 'create';
                const payload = campaignId ? {
                    action: action,
                    campaign_id: campaignId,
                    updates: { title, subject, from_name: fromName, from_email: fromEmail, content_html: contentHtml, segment, status }
                } : {
                    action: action,
                    title, subject, from_name: fromName, from_email: fromEmail, content_html: contentHtml, segment, status
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                alert(data.message);
                bootstrap.Modal.getInstance(document.getElementById('campaignModal')).hide();
                loadCampaigns();
            } catch (error) {
                console.error('Error saving campaign:', error);
                alert('Failed to save campaign');
            }
        }

        async function sendCampaign() {
            if (!confirm('Send this campaign now to all subscribers?')) return;
            
            await saveCampaign('sending');
            
            const campaignId = document.getElementById('campaignId').value;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'send', campaign_id: campaignId })
                });
                
                const data = await response.json();
                alert(data.message + '\nRecipients: ' + data.recipient_count);
                bootstrap.Modal.getInstance(document.getElementById('campaignModal')).hide();
                loadCampaigns();
            } catch (error) {
                console.error('Error sending campaign:', error);
                alert('Failed to send campaign');
            }
        }

        async function sendTestEmail() {
            const testEmail = prompt('Enter email address for test:');
            if (!testEmail) return;
            
            await saveCampaign('draft');
            
            const campaignId = document.getElementById('campaignId').value;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'send', campaign_id: campaignId, test_email: testEmail })
                });
                
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                console.error('Error sending test:', error);
                alert('Failed to send test email');
            }
        }

        async function showStats(campaignId) {
            try {
                const response = await fetch(TRACKING_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_stats', campaign_id: campaignId })
                });
                
                const data = await response.json();
                const stats = data.stats;
                
                const html = `
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3>${stats.recipient_count}</h3>
                            <small>Recipients</small>
                        </div>
                        <div class="col-md-3">
                            <h3>${stats.open_count}</h3>
                            <small>Opens (${stats.open_rate}%)</small>
                        </div>
                        <div class="col-md-3">
                            <h3>${stats.click_count}</h3>
                            <small>Clicks (${stats.click_rate}%)</small>
                        </div>
                        <div class="col-md-3">
                            <h3>${stats.unsubscribe_count}</h3>
                            <small>Unsubscribes (${stats.unsubscribe_rate}%)</small>
                        </div>
                    </div>
                    <hr>
                    <p><strong>Campaign:</strong> ${stats.title}</p>
                    <p><strong>Status:</strong> ${stats.status}</p>
                    <p><strong>Sent:</strong> ${stats.sent_at ? new Date(stats.sent_at).toLocaleString() : 'N/A'}</p>
                `;
                
                document.getElementById('statsContent').innerHTML = html;
                new bootstrap.Modal(document.getElementById('statsModal')).show();
            } catch (error) {
                console.error('Error loading stats:', error);
                alert('Failed to load statistics');
            }
        }

        function viewCampaign(campaignId) {
            editCampaign(campaignId);
        }
    </script>
</body>
</html>

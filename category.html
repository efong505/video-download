<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Categories - AWS Video Downloader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 15px;
        }
        .nav-links {
            display: flex;
            gap: 15px;
        }
        .nav-links a {
            color: #007bff;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #007bff;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .nav-links a:hover {
            background-color: #007bff;
            color: white;
        }
        .category-filter {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .tag-button {
            padding: 8px 16px;
            border: 1px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tag-button:hover, .tag-button.active {
            background-color: #007bff;
            color: white;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .video-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .video-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .video-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }
        .video-info {
            padding: 15px;
        }
        .video-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .video-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        .video-tag {
            background-color: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .no-videos {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Video Categories</h1>
            <div class="nav-links">
                <a href="videos.html">All Videos</a>
                <a href="index.html">Home</a>
                <button onclick="logout()" style="background: none; border: 1px solid #dc3545; color: #dc3545; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Logout</button>
            </div>
        </div>

        <div class="category-filter">
            <span style="font-weight: bold;">Filter by tag:</span>
            <button class="tag-button active" onclick="filterByTag('all')">All</button>
            <div id="tagButtons"></div>
        </div>

        <div id="loading" class="loading">Loading videos...</div>
        <div id="videoGrid" class="video-grid" style="display: none;"></div>
        <div id="noVideos" class="no-videos" style="display: none;">No videos found for this category.</div>
    </div>

    <script>
        const CLOUDFRONT_URL = 'https://d271vky579caz9.cloudfront.net';
        const VIDEO_LIST_API = 'https://wfeds5lejb.execute-api.us-east-1.amazonaws.com/prod/api/videos';
        const TAG_API = 'https://h4hoegi26b.execute-api.us-east-1.amazonaws.com/prod/tags';
        
        let allVideos = [];
        let allTags = new Set();
        let currentFilter = 'all';

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = 'login.html';
        }

        async function loadVideos() {
            if (!checkAuth()) return;

            try {
                // Get all videos from S3
                const videoResponse = await fetch(VIDEO_LIST_API);
                const videoData = await videoResponse.json();
                
                if (videoData.videos) {
                    // Get all tags first
                    try {
                        const tagResponse = await fetch(`${TAG_API}?action=get_all_tags`);
                        const tagData = await tagResponse.json();
                        if (tagData.tags) {
                            tagData.tags.forEach(tag => allTags.add(tag));
                        }
                    } catch (error) {
                        console.log('No tags found or error loading tags');
                    }

                    // For each video, try to get its metadata, but don't fail if it doesn't exist
                    allVideos = videoData.videos.map(video => ({
                        ...video,
                        title: video.filename,
                        tags: []
                    }));

                    renderTagButtons();
                    renderVideos();
                } else {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('noVideos').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                document.getElementById('loading').innerHTML = 'Error loading videos. Please try again.';
            }
        }

        function renderTagButtons() {
            const tagButtonsContainer = document.getElementById('tagButtons');
            const sortedTags = Array.from(allTags).sort();
            
            tagButtonsContainer.innerHTML = sortedTags.map(tag => 
                `<button class="tag-button" onclick="filterByTag('${tag}')">${tag}</button>`
            ).join('');
        }

        function filterByTag(tag) {
            currentFilter = tag;
            
            // Update active button
            document.querySelectorAll('.tag-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderVideos();
        }

        function renderVideos() {
            const videoGrid = document.getElementById('videoGrid');
            const loading = document.getElementById('loading');
            const noVideos = document.getElementById('noVideos');
            
            let filteredVideos = allVideos;
            if (currentFilter !== 'all') {
                filteredVideos = allVideos.filter(video => video.tags.includes(currentFilter));
            }

            loading.style.display = 'none';
            
            if (filteredVideos.length === 0) {
                videoGrid.style.display = 'none';
                noVideos.style.display = 'block';
                return;
            }

            noVideos.style.display = 'none';
            videoGrid.style.display = 'grid';
            
            videoGrid.innerHTML = filteredVideos.map(video => {
                const thumbnailUrl = `${CLOUDFRONT_URL}/thumbnails/${video.filename.replace(/\.[^/.]+$/, '')}_thumb_2.jpg`;
                const fallbackThumbnailUrl = `${CLOUDFRONT_URL}/thumbnails/${video.filename.replace(/\.[^/.]+$/, '')}_thumb.jpg`;
                const videoUrl = `${CLOUDFRONT_URL}/videos/${video.filename}`;
                
                return `
                    <div class="video-item">
                        <img src="${thumbnailUrl}" 
                             alt="${video.title}" 
                             class="video-thumbnail"
                             onerror="this.src='${fallbackThumbnailUrl}'"
                             onclick="playVideo('${videoUrl}', '${video.title}')">
                        <div class="video-info">
                            <div class="video-title">${video.title}</div>
                            <div class="video-tags">
                                ${video.tags.map(tag => `<span class="video-tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function playVideo(videoUrl, title) {
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { margin: 0; background: black; display: flex; justify-content: center; align-items: center; height: 100vh; }
                        video { max-width: 100%; max-height: 100%; }
                    </style>
                </head>
                <body>
                    <video controls autoplay>
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </body>
                </html>
            `);
        }

        // Load videos when page loads
        window.addEventListener('load', async function() {
            // Check if user is admin and add admin link
            const userData = localStorage.getItem('user_data');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.role === 'admin') {
                        const navLinks = document.querySelector('.nav-links');
                        const adminLink = document.createElement('a');
                        adminLink.href = 'admin.html';
                        adminLink.textContent = 'Admin Dashboard';
                        navLinks.insertBefore(adminLink, navLinks.lastElementChild);
                    }
                } catch (error) {
                    console.log('Error parsing user data');
                }
            }
            
            await loadVideos();
            // After loading videos, get metadata for videos that have tags
            await loadVideoMetadata();
        });

        async function loadVideoMetadata() {
            // Only load metadata for videos if we have tags
            if (allTags.size === 0) return;

            try {
                // Get videos by each tag to build metadata
                const tagPromises = Array.from(allTags).map(async (tag) => {
                    try {
                        const response = await fetch(`${TAG_API}?action=get_videos_by_tag&tag=${encodeURIComponent(tag)}`);
                        const data = await response.json();
                        return data.videos || [];
                    } catch (error) {
                        return [];
                    }
                });

                const tagResults = await Promise.all(tagPromises);
                const videoMetadata = new Map();

                // Build metadata map
                tagResults.flat().forEach(video => {
                    if (video.filename) {
                        videoMetadata.set(video.filename, {
                            title: video.title || video.filename,
                            tags: video.tags || []
                        });
                    }
                });

                // Update allVideos with metadata
                allVideos = allVideos.map(video => {
                    const metadata = videoMetadata.get(video.filename);
                    return {
                        ...video,
                        title: metadata ? metadata.title : video.filename,
                        tags: metadata ? metadata.tags : []
                    };
                });

                renderVideos();
            } catch (error) {
                console.error('Error loading video metadata:', error);
            }
        }
    </script>
</body>
</html>
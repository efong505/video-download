<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Management - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        @media (min-width: 1200px) {.container {max-width: 1160px !important;}}
        .nav-tabs { margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #0d6efd; }
        #editor { height: 300px; }
        .content-block { padding: 15px; margin: 10px 0; border: 2px dashed #ccc; border-radius: 5px; cursor: move; background: #f8f9fa; }
        .content-block:hover { border-color: #0d6efd; background: #e7f1ff; }
        .drop-zone { min-height: 100px; border: 2px dashed #ccc; border-radius: 5px; padding: 20px; margin: 10px 0; }
        .drop-zone.drag-over { border-color: #0d6efd; background: #e7f1ff; }
        #preview-content { border: 1px solid #ddd; padding: 20px; background: white; min-height: 400px; }
    </style>
</head>
<body>
    <div id="navbar-container" data-page="admin-newsletters"></div>

    <div class="container my-5" style="margin-top: 5rem !important;">
        <h1 class="mb-4">ðŸ“§ Newsletter Management</h1>

        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#newsletters">Newsletters</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#subscribers">Subscribers</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#templates">Templates</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#campaigns">Campaigns</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#analytics">Analytics</a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Newsletters Tab -->
            <div id="newsletters" class="tab-pane fade show active">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number" id="totalNewsletters">0</div>
                            <div>Total Newsletters</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number" id="sentNewsletters">0</div>
                            <div>Sent</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-number" id="draftNewsletters">0</div>
                            <div>Drafts</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#newsletterModal" onclick="openNewsletter()">Create Newsletter</button>
                <button class="btn btn-secondary mb-3 ms-2" onclick="window.location.href='newsletter-archive.html'">View Archive</button>

                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Recipients</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="newslettersList"></tbody>
                </table>
            </div>

            <!-- Subscribers Tab -->
            <div id="subscribers" class="tab-pane fade">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="stat-card">
                            <div class="stat-number" id="activeSubscribers">0</div>
                            <div>Active Subscribers</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-card">
                            <div class="stat-number" id="unsubscribed">0</div>
                            <div>Unsubscribed</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addSubscriberModal">âž• Add Subscriber</button>
                <button class="btn btn-primary mb-3 ms-2" data-bs-toggle="modal" data-bs-target="#bulkImportModal">ðŸ“¤ Bulk Import CSV</button>

                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Subscribed</th>
                            <th>Source</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subscribersList"></tbody>
                </table>
            </div>

            <!-- Templates Tab -->
            <div id="templates" class="tab-pane fade">
                <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#templateModal">Create Template</button>
                <div id="templatesList" class="row"></div>
            </div>

            <!-- Campaigns Tab -->
            <div id="campaigns" class="tab-pane fade">
                <h4>Subscriber Segments</h4>
                <p>Manage subscriber campaigns/segments for targeted newsletters.</p>
                <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#campaignModal" onclick="openNewCampaign()">âž• Create Campaign</button>
                <div class="row mb-4" id="campaignCards"></div>
                <h5>Manage Subscribers by Campaign</h5>
                <select class="form-select mb-3" id="campaignFilter" onchange="filterByCampaign()">
                    <option value="all">All Subscribers</option>
                </select>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Campaigns</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="campaignSubscribersList"></tbody>
                </table>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-pane fade">
                <h4>Newsletter Analytics</h4>
                <div id="analyticsData"></div>
            </div>
        </div>
    </div>

    <!-- Campaign Modal -->
    <div class="modal fade" id="campaignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="campaignModalTitle">Create Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="campaignId">
                    <div class="mb-3">
                        <label for="campaignName" class="form-label">Campaign Name *</label>
                        <input type="text" class="form-control" id="campaignName" required>
                    </div>
                    <div class="mb-3">
                        <label for="campaignDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="campaignDescription" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="saveCampaign()">Save Campaign</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="navbar.js"></script>
    <script>
        const API_URL = 'https://gu6c08ctel.execute-api.us-east-1.amazonaws.com/prod/newsletter';

        $(document).ready(function() {
            const authToken = localStorage.getItem('auth_token');
            const userData = localStorage.getItem('user_data');
            
            if (!authToken || !userData) {
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userData);
            if (user.role !== 'admin' && user.role !== 'super_user') {
                alert('Access denied. Admin only.');
                window.location.href = 'index.html';
                return;
            }

            fetch('navbar.html')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('navbar-container').innerHTML = html;
                    initNavbar();
                });

            $('#editor').attr('contenteditable', 'true').css('background', 'white');

            loadNewsletters();
            loadSubscribers();
            loadTemplates();
            loadCampaigns();
            
            $('a[href="#analytics"]').on('shown.bs.tab', function() {
                loadAnalytics();
            });
            
            $('a[href="#campaigns"]').on('shown.bs.tab', function() {
                loadCampaigns();
                filterByCampaign();
            });
            
            $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
                const target = $(e.target).attr('href');
                if (target === '#htmlEditor') {
                    $('#htmlContent').val($('#editor').html());
                } else if (target === '#visualEditor') {
                    $('#editor').html($('#htmlContent').val());
                }
            });
        });

        function loadCampaigns() {
            Promise.all([
                fetch(API_URL + '?action=list_campaigns').then(r => r.json()),
                fetch(API_URL + '?action=list_subscribers').then(r => r.json())
            ]).then(([campaignsData, subscribersData]) => {
                const campaigns = campaignsData.campaigns || [];
                const subscribers = subscribersData.subscribers || [];
                const active = subscribers.filter(s => s.status === 'active');
                
                const cardsContainer = $('#campaignCards');
                cardsContainer.empty();
                
                const filterSelect = $('#campaignFilter');
                filterSelect.find('option:not(:first)').remove();
                
                campaigns.forEach(c => {
                    const count = active.filter(s => (s.campaigns || []).includes(c.campaign_id)).length;
                    cardsContainer.append(`
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5>${c.name}</h5>
                                    <p class="text-muted small">${c.description || ''}</p>
                                    <span class="badge bg-primary">${count}</span>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editCampaign('${c.campaign_id}')">Edit</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCampaign('${c.campaign_id}')">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                    filterSelect.append(`<option value="${c.campaign_id}">${c.name}</option>`);
                });
                
                updateCampaignSelects(campaigns);
            });
        }
        
        function updateCampaignSelects(campaigns) {
            const campaignSelect = $('#campaign');
            campaignSelect.empty();
            campaigns.forEach(c => {
                campaignSelect.append(`<option value="${c.campaign_id}">${c.name}</option>`);
            });
        }
        
        function openNewCampaign() {
            $('#campaignModalTitle').text('Create Campaign');
            $('#campaignId').val('');
            $('#campaignName').val('');
            $('#campaignDescription').val('');
        }
        
        function editCampaign(id) {
            fetch(API_URL + '?action=list_campaigns')
                .then(r => r.json())
                .then(data => {
                    const campaign = (data.campaigns || []).find(c => c.campaign_id === id);
                    if (campaign) {
                        $('#campaignModalTitle').text('Edit Campaign');
                        $('#campaignId').val(campaign.campaign_id);
                        $('#campaignName').val(campaign.name);
                        $('#campaignDescription').val(campaign.description || '');
                        $('#campaignModal').modal('show');
                    }
                });
        }
        
        function saveCampaign() {
            const id = $('#campaignId').val();
            const name = $('#campaignName').val().trim();
            if (!name) {
                alert('Campaign name is required');
                return;
            }
            
            const data = {
                action: id ? 'update_campaign' : 'create_campaign',
                campaign_id: id || name.toLowerCase().replace(/\s+/g, '_'),
                name: name,
                description: $('#campaignDescription').val().trim()
            };
            
            fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => {
                $('#campaignModal').modal('hide');
                loadCampaigns();
                alert('Campaign saved!');
            });
        }
        
        function deleteCampaign(id) {
            if (!confirm('Delete this campaign? Subscribers will keep their assignments.')) return;
            
            fetch(API_URL + '?action=delete_campaign&campaign_id=' + id)
                .then(r => r.json())
                .then(() => {
                    loadCampaigns();
                    alert('Campaign deleted!');
                });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Archive - Christian Conservatives Today</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @media (min-width: 1200px) {.container {max-width: 1160px !important;}}
        .newsletter-card { margin-bottom: 20px; transition: transform 0.2s; }
        .newsletter-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .newsletter-content { max-height: 200px; overflow: hidden; position: relative; }
        .newsletter-content::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 50px; background: linear-gradient(transparent, white); }
    </style>
</head>
<body>
    <div id="navbar-container" data-page="newsletter-archive"></div>

    <div class="container my-5" style="margin-top: 5rem !important;">
        <h1 class="mb-4">ðŸ“§ Newsletter Archive</h1>
        <p class="lead">Browse our past newsletters and stay informed on Christian conservative news and updates.</p>

        <div class="row mb-4">
            <div class="col-md-8">
                <input type="text" class="form-control" id="searchBox" placeholder="Search newsletters...">
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100" onclick="window.location.href='subscribe.html'">ðŸ“¬ Subscribe to Newsletter</button>
            </div>
        </div>

        <div id="newslettersList" class="row"></div>
    </div>

    <!-- View Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="viewContent" style="max-width: 600px; margin: 0 auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="shareNewsletter()">ðŸ“¤ Share</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="navbar.js"></script>
    <script>
        const API_URL = 'https://gu6c08ctel.execute-api.us-east-1.amazonaws.com/prod/newsletter';
        let currentNewsletter = null;

        $(document).ready(function() {
            fetch('navbar.html')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('navbar-container').innerHTML = html;
                    initNavbar();
                });

            loadNewsletters();

            $('#searchBox').on('input', function() {
                const query = $(this).val().toLowerCase();
                $('.newsletter-card').each(function() {
                    const text = $(this).text().toLowerCase();
                    $(this).toggle(text.includes(query));
                });
            });
        });

        function loadNewsletters() {
            fetch(API_URL + '?action=list_newsletters&status=sent')
                .then(r => r.json())
                .then(data => {
                    const newsletters = data.newsletters || [];
                    const container = $('#newslettersList');
                    container.empty();

                    if (newsletters.length === 0) {
                        container.append('<div class="col-12"><p class="text-center text-muted">No newsletters available yet.</p></div>');
                        return;
                    }

                    newsletters.forEach(n => {
                        const date = new Date(n.sent_at).toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
                        const preview = stripHtml(n.content).substring(0, 200) + '...';
                        
                        container.append(`
                            <div class="col-md-6 newsletter-card">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">${n.title}</h5>
                                        <p class="text-muted small">ðŸ“… ${date} â€¢ ðŸ‘¥ ${n.recipient_count || 0} recipients</p>
                                        <div class="newsletter-content">
                                            <p class="card-text">${preview}</p>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-sm btn-primary" onclick="viewNewsletter('${n.newsletter_id}')">Read Full Newsletter</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="copyShareLink('${n.newsletter_id}')">ðŸ“‹ Copy Link</button>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                });
        }

        function viewNewsletter(id) {
            fetch(API_URL + '?action=get_newsletter&newsletter_id=' + id)
                .then(r => r.json())
                .then(data => {
                    currentNewsletter = data.newsletter;
                    $('#viewTitle').text(currentNewsletter.title);
                    $('#viewContent').html(currentNewsletter.content);
                    $('#viewModal').modal('show');
                });
        }

        function shareNewsletter() {
            if (!currentNewsletter) return;
            const url = `${window.location.origin}/newsletter-archive.html?id=${currentNewsletter.newsletter_id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: currentNewsletter.title,
                    text: currentNewsletter.subject,
                    url: url
                });
            } else {
                copyToClipboard(url);
                alert('Share link copied to clipboard!');
            }
        }

        function copyShareLink(id) {
            const url = `${window.location.origin}/newsletter-archive.html?id=${id}`;
            copyToClipboard(url);
            alert('Share link copied to clipboard!');
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // Check if opened with specific newsletter ID
        const urlParams = new URLSearchParams(window.location.search);
        const newsletterId = urlParams.get('id');
        if (newsletterId) {
            setTimeout(() => viewNewsletter(newsletterId), 500);
        }
    </script>
</body>
</html>
